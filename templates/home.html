{%- extends "page.html" -%}
{%- import "macros/home.jinja" as home -%}
{%- import "macros/inputs.jinja" as inputs -%}
{%- import "macros/svgs.jinja" as svg -%}

{%- block stylesheet -%}
  <link rel="stylesheet" href='{{static_url("css/home.css")}}' type="text/css"/>
{%- endblock -%}

{#- Set some convenience variables -#}
{%- set named_spawners = [] -%}
{%- for s in user.all_spawners(include_default=False) | list -%}
  {%- if s.orm_spawner.user_options -%}
    {%- if (
        "profile" in s.orm_spawner.user_options 
        and s.orm_spawner.user_options.get("profile").startswith("JupyterLab")
      )
      or (
        "service" in s.orm_spawner.user_options
        and s.orm_spawner.user_options.get("service").startswith("JupyterLab")
      )
    -%}
    {%- do named_spawners.append(s) -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}
{%- set custom_config = auth_state.get("custom_config", {}) -%}
{%- set dropdown_options = auth_state.get("options_form", {}).get("dropdown_list", {}) -%}
{%- set userModules = custom_config.get("userModules", {}) -%}
{%- set new = "new_jupyterlab" -%}  {# id for new jupyterlabs. Cannot contain "-" #}

{%- macro create_summary_tr(s, user_options) -%}
{%- set id = s.orm_spawner.name -%}
{%- set name = user_options.get("name") -%}
{%- set system = user_options.get("system", "") -%}
{%- set flavor = user_options.get("flavor", "") -%}
{%- set partition = user_options.get("partition", "") -%}
{%- set project = user_options.get("project", "") -%}
{%- set runtime = user_options.get("runtime", "") -%}
{%- set nodes = user_options.get("nodes", "") -%}
{%- set gpus = user_options.get("gpus", "") -%}
<tr data-server-id="{{id}}" class="summary-tr">
  <td class="details-td" data-bs-target="#{{id}}-collapse">
    <div class="d-flex mx-auto accordion-icon collapsed mx-4"></div>
  </td>
  <th scope="row" class="name-td">{{ name }}</th> 
  <td class="config-td">
    <div style="max-height: 152px; overflow: auto;">
      {%- macro _config_td_entry(label, value) %}
        <span class="text-muted" style="font-size: smaller;">{{ label }}</span><br>
        <span id="{{id}}-config-td-{{label|lower}}">{{ value }}</span>
      {%- endmacro -%}
      {%- set row_margins = "mx-3 mb-1" -%}
      {%- set row_breakpoints = "col-12 col-md-6 col-lg-12" -%}
      {%- set breakpoints = "col-12 col-lg-4" %}
      <div class="row {{row_margins}} justify-content-between">
        <div class="row {{row_breakpoints}}">
          <div class="col text-lg-start {{breakpoints}}">
          {%- if system %} {{ _config_td_entry("System", system) }} {%- endif %}
          </div>
          <div class="col text-lg-center {{breakpoints}}">
          {%- if flavor %} {{ _config_td_entry("Flavor", flavor) }}
          {%- elif partition %} {{ _config_td_entry("Partition", partition) }} {%- endif %}
          </div>
          <div class="col text-lg-end {{breakpoints}}">
          {%- if project %} {{ _config_td_entry("Project", project) }} {%- endif %}
          </div>
        </div>
        <div class="row {{row_breakpoints}}">
          <div class="col text-lg-start {{breakpoints}}">
          {%- if runtime %} {{ _config_td_entry("Runtime", (runtime)|int) }}  min {%- endif %}
          </div>
          <div class="col text-lg-center {{breakpoints}}">
          {%- if nodes %} {{ _config_td_entry("Nodes", nodes) }} {%- endif %}
          </div>
          <div class="col text-lg-end {{breakpoints}}">
          {%- if gpus %} {{ _config_td_entry("GPUs", gpus) }} {%- endif %}
          </div>
        </div>
      </div>
    </div>
  </td>
  {{ home.create_lab_progress_td(id) }}
  {{ home.create_action_td(s, user, id) }}
</tr>
{%- endmacro -%}

{%- macro create_collapsible_tr(id, user_options, show_logs=True) -%}
{%- set name = user_options.get("name", "") -%}
<tr data-server-id="{{id}}" class="collapsible-tr" style="--bs-table-accent-bg: transparent;">
  <td colspan="100%" class="p-0">  {#- Remove padding to hide td when collapsed #}
    <div class="collapse" id="{{id}}-collapse">
      <div class="d-flex align-items-start m-3">
        {#- TAB NAV PILLS -#}
        {%- set nav_tab_margins = "mb-3" %}
        <div class="nav flex-column nav-pills p-3 ps-0" id="{{ id }}-tab" role="tablist">
          <button class="nav-link active {{ nav_tab_margins }}" id="{{ id }}-config-tab" data-bs-toggle="pill" data-bs-target="#{{ id }}-config" type="button" role="tab">Lab Config</button>
          <button class="nav-link {{ nav_tab_margins }}" id="{{ id }}-resources-tab" data-bs-toggle="pill" data-bs-target="#{{ id }}-resources" type="button" role="tab">
            <span>Resources</span>
            <span id="{{id}}-resources-tab-warning" class="d-flex invisible">
              {{ svg.warning_svg | safe }}
              <span class="visually-hidden">settings changed</span>
            </span>
          </button>
          <button class="nav-link {{ nav_tab_margins }}" id="{{ id }}-modules-tab" data-bs-toggle="pill" data-bs-target="#{{ id }}-modules" type="button" role="tab">
            <span>Kernels and Extensions</span>
            <span id="{{id}}-modules-tab-warning" class="d-flex invisible">
              {{ svg.warning_svg | safe }}
              <span class="visually-hidden">settings changed</span>
            </span>
          </button>
          {%- if id != new %}
          <button class="nav-link {{ nav_tab_margins }}" id="{{ id }}-logs-tab" data-bs-toggle="pill" data-bs-target="#{{ id }}-logs" type="button" role="tab">Logs</button>
          {%- endif %}
        </div>
        {#- TAB NAV CONTENT -#}
        {#- We only create empty elements here as they will be filled via JS #}
        <div class="tab-content w-100" id="{{ id }}-tabContent">
          <div class="tab-pane fade show active" id="{{ id }}-config" role="tabpanel">
            <form id="{{id}}-lab-config-form">
              {{ inputs.create_text_input(id, "name", placeholder="Give your lab a name") }}
              {{ inputs.create_select(id, custom_config.get("services").get("JupyterLab").get("options_name", "version")) }}
              <hr>
              {{ inputs.create_select(id, "system") }}
              {{ inputs.create_select(id, "flavor") }}
              <div id="{{id}}-flavor-info-div">
                <span class="fw-bold">Available flavors</span>
              </div>
              {{ inputs.create_select(id, "account") }}
              {{ inputs.create_select(id, "project") }}
              {{ inputs.create_select(id, "partition") }}
              <hr id="{{id}}-reservation-hr">
              {{ inputs.create_select(id, "reservation") }}
              <div id="{{id}}-reservation-info-div" class="row mb-3">
                {%- set reservation_info_classes = "col-4 fw-bold"%}
                <div id="{{id}}-reservation-info" class="col-8 offset-4">
                  <div class="row">
                    <span class="{{ reservation_info_classes }}">Start Time:</span>
                    <span id="{{id}}-reservation-start" class="col-auto"></span>
                  </div>
                  <div class="row">
                    <span class="{{ reservation_info_classes }}">End Time:</span>
                    <span id="{{id}}-reservation-end" class="col-auto"></span>
                  </div>
                  <div class="row">
                    <span class="{{ reservation_info_classes }}">State:</span>
                    <span id="{{id}}-reservation-state" class="col-auto"></span>
                  </div>
                  <div class="mt-1">
                    <details>
                      <summary class="fw-bold">Detailed reservation information:</summary>
                      <pre id="{{id}}-reservation-details"></pre>
                      {#- TODO: Fix horizontal width upon expanding the detail #}
                    </details>
                  </div>
                </div>
              </div>
            </form>
            {{ home.create_lab_config_buttons(id, id == new) }}
          </div>
          <div class="tab-pane fade" id="{{ id }}-resources" role="tabpanel">
            <form id="{{id}}-resources-form">
              {{ inputs.create_number_input(id, "nodes") }}
              {{ inputs.create_number_input(id, "gpus", "GPUs") }}
              {{ inputs.create_number_input(id, "runtime", "Runtime (minutes)") }}
              {{ inputs.create_checkbox_input(id, "xcbserver", "Activate XServer")}}
              {{ inputs.create_number_input(id, "xserver", "Use XServer GPU Index") }}
            </form>
            {{ home.create_lab_config_buttons(id, id == new) }}
          </div>
          <div class="tab-pane fade" id="{{ id }}-modules" role="tabpanel">
            <form id="{{id}}-modules-form">
              {%- for module_set in custom_config.get("userModules", {}).keys() %}
              <div id="{{id}}-{{module_set}}-div">
                <h4>{{ module_set | title}}</h4>
                <div id="{{id}}-{{module_set}}-checkboxes-div" class="row g-0"></div>
              </div>
              {%- endfor %}
            </form>
            <hr>
            <div id="{{id}}-modules-selector-div" class="row g-0">
              {%- set module_cols = "col-sm-6 col-md-4 col-lg-3" %}
              <div class="form-check {{module_cols}}">
                <input class="form-check-input module-selector" type="checkbox" id="{{id}}-modules-select-all">
                <label class="form-check-label" for="{{id}}-modules-select-all">Select all</label>
              </div>
              <div class="form-check {{module_cols}}">
                <input class="form-check-input module-selector" type="checkbox" id="{{id}}-modules-select-none">
                <label class="form-check-label" for="{{id}}-modules-select-none">Deselect all</label>
              </div>
            </div>
            {{ home.create_lab_config_buttons(id, id == new) }}
          </div>
          <div class="tab-pane fade" id="{{ id }}-logs" role="tabpanel">
              {{ inputs.create_select(id, "log") }}
              <div id="{{id}}-log" class="card card-body"></div>
              {{ home.create_lab_config_buttons(id, id == new) }}
          </div>
        </div>
      </div>
    </div>
  </td>
</tr>
{%- endmacro -%}


{%- block main -%}
<div class="container-fluid p-4">
  {#- ANNOUNCEMENT #}
  {%- if custom_config.get("announcement", {}).get("show", False) %}
  {{ home.create_announcement(custom_config) }}
  {%- endif -%}

  {#- TABLE #}
  <p>You can configure your existing JupyterLabs by expanding the corresponding table row.</p>
  <div class="table-responsive-md">
    <table id="jupyterlabs-table" class="table table-bordered table-striped table-hover table-light align-middle">
    {#- TABLE HEAD #}
      <thead class="table-secondary">
        <tr>
          <th scope="col" width="1%"></th>
          <th scope="col" width="20%">Name</th>
          <th scope="col">Configuration</th>
          <th scope="col" width="10%;">Status</th>
          <th scope="col" width="10%;">Actions</th>
        </tr>
      </thead>
      {#- TABLE BODY #}
      <tbody>
        {#- New JupyterLab row #}
        <tr data-server-id="{{ new }}" class="new-spawner-tr summary-tr">
          <th scope="col" class="details-td">
            <div class="d-flex mx-4">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-plus-lg m-auto" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
              </svg>
            </div>
          </th>
          <th scope="row" colspan="100%" class="text-center">New JupyterLab</th>
        </tr>
        {{ create_collapsible_tr(new, {}) }}
        {#- Existing JupyterLab rows -#}
        {#- By looping through named_spawners #}
        {%- for s in named_spawners -%}
          {%- set user_options = s.orm_spawner.user_options -%}
          {%- set name = user_options.get("name") -%}
          {{ create_summary_tr(s, user_options) }}
          {{ create_collapsible_tr(s.orm_spawner.name, user_options) }}
        {%- endfor %}
      </tbody>
    </table>
  </div>  {#- table responsive #}
</div>  {#- container fluid #}
{%- endblock -%}


{%- block script -%}
<script src='{{static_url("js/handleServers.js", include_version=False) }}' type="text/javascript" charset="utf-8"></script>

<script>
{#- Manually sets some cancel related variables -#}
{%- set cancel_progress_activation = 30 -%}
{#- Percentage when cancel should be disabled again
    since it is already in progress -#}
{%- set cancel_progress_deactivation = 99 %}

{#- Save some global variables #}
var evtSources = {};
var userOptions = {};
var spawnEvents = {};
{%- for s in named_spawners -%}
{%- set spawner = s.orm_spawner -%}
{%- set userOptions = spawner.user_options -%}
userOptions["{{spawner.name}}"] = {{ userOptions | tojson }}
{%- if spawner.state and spawner.state.get("events") %}
spawnEvents["{{spawner.name}}"] = {{ spawner.state.get("events") | tojson }};
{%- else -%}
{#- We still want to show a "latest" entry for the log dropdown,
so we manually create an entry for spawners without events #}
spawnEvents["{{spawner.name}}"] = {"latest": []};
{%- endif -%}
{%- endfor %}
var systemsHealth = {};
</script>

<script>
{# Callbacks related to interacting with table rows -#}

// Toggle the collapsible table row on table row click
$(".summary-tr").click(function() {
  let id = $(this).data("server-id");
  let accordionIcon = $(this).find(".accordion-icon");
  let collapse = $(`.collapse[id*=${id}]`);
  let shown = collapse.hasClass("show");
  if (shown) accordionIcon.addClass("collapsed");
  else accordionIcon.removeClass("collapsed");
  new bootstrap.Collapse(collapse);
});
// but not when the action td button are clicked
$(".actions-td button").click(function (event) {
  event.preventDefault();
  event.stopPropagation();
})
// Hide warning icons on tab click
$("button[role=tab]").click(function() {
  let warning = $(this).find("[id$=tab-warning]");
  warning.addClass("invisible");
})
// Toggle log tabs on log button or info text click
$(".log-info-btn, .progress-info-text").click(function() {
  let id = $(this).parents("tr").data("server-id");
  let accordionIcon = $(this).find(".accordion-icon");
  let collapse = $(`.collapse[id*=${id}]`);
  let shown = collapse.hasClass("show");
  // Prevent collapse from closing if it is already open,
  // but not showing the logs tab.
  if (shown && !$(`#${id}-logs-tab`).hasClass("active")) {
    event.preventDefault();
    event.stopPropagation();
  }
  // Change to the log tab
  var trigger = $(`#${id}-logs-tab`);
  var tab = new bootstrap.Tab(trigger);
  tab.show();
});
// Show selected logs
$("select[id*=log-select]").change(function() {
  const id = getId(this);
  const val = $(this).val();
  var log = $(`#${id}-log`);
  log.html("");
  for (const event of spawnEvents[id][val]) {
    _appendToLog(event["html_message"], log);
  }
})
</script>

<script>
const dropdownOptions = {{dropdown_options | tojson}};

function resetInputElement(element, required=true) {
  element.html("");
  element.val(null);
  element.removeClass("text-muted disabled");
  element.attr("required", required);
}

function updateLabConfigSelect(select, value, lastSelected) {
  // For some systems, e.g. cloud, some options are not available
  if (select.html() == "") {
    select.append("<option disabled>Not available</option>");
    select.addClass("text-muted").removeAttr("required");
  }
  // If there is only one option, we disable the dropdown
  const numberOfOptions = select.children().length
  if (numberOfOptions == 1) {
    select.addClass("disabled");
  }
  if (value) select.val(value);
  else {
    // Check if the last value is contained in the new options,
    // otherwise just select the first value.
    var index = 0;
    select.children().each(function (i, option) {
      if ($(option).val() == lastSelected) {
        index = i;
        /* Although index should be used to set the value and
          avoid the (index == 0) query, indices don't work directly
          when there are optiongroups in the select. So we set
          it via the .val() function regardless. */
        select.val(lastSelected);
        return;
      }
    })
    if (index == 0) select.prop("selectedIndex", index);
  }
  select[0].dispatchEvent(new Event("change"));
}

function updateLabConfigInput(input, value, lastSelected, min, max, defaultValue) {
  input.attr({ "min": min, "max": max});
  input.attr("required", true);
  // Set message for invalid feedback
  input.siblings(".invalid-feedback")
    .text(`Please choose a number between ${min} and ${max}.`);
  if (value) {
    input.val(value);
  }
  // Check if we can keep the old value
  else if (lastSelected != "" && lastSelected >= min && lastSelected <= max) {
    input.val(lastSelected);
  }
  else {
    input.val(defaultValue);
  }
}

function updateService(id, value) {
  const serviceInfos = {{custom_config.get("services") | tojson}};

  let select = $(`select#${id}-version-select`);
  const currentVal = select.val();
  resetInputElement(select);
  for (const service of Object.keys(dropdownOptions).sort().reverse())  {
    var serviceName = (serviceInfos.JupyterLab.options[service] || {}).name || service;
    select.append(`<option value="${service}">${serviceName}</option>`);
  }
  if (!value) value = serviceInfos.JupyterLab.defaultOption;
  updateLabConfigSelect(select, value, currentVal);
}

function updateSystems(id, service, value) {
  const systemInfos = {{custom_config.get("systems") | tojson}} || {};

  let select = $(`select#${id}-system-select`);
  const currentVal = select.val();
  resetInputElement(select);

  const systemsAllowed = dropdownOptions[service] || {};
  for (const system of Object.keys(systemInfos).sort((a,b) => (systemInfos[a]["weight"] || 99) < (systemInfos[b]["weight"] || 99) ? -1 : 1)) {
    if (system in systemsAllowed) select.append(`<option value="${system}">${system}</option>`);
  }
  updateLabConfigSelect(select, value, currentVal);
}

function updateFlavors(id, service, system, value) {
  const systemInfos = {{custom_config.get("systems") | tojson}} || {};
  let select = $(`select#${id}-flavor-select`);
  const currentVal = select.val();

  let flavorUrl = location.origin + window.jhdata.base_url + "api/outpostflavors?_xsrf=" + window.jhdata.xsrf_token;
  $.get( flavorUrl, function(data) {
    resetInputElement(select);
    $(`#${id}-flavor-info-div`).html("");

    const flavorsAllowed = data[system] || {};
    for (const flavor of Object.keys(flavorsAllowed).sort()) {
      let current = flavorsAllowed[flavor].current || 0;
      let max_allowed = flavorsAllowed[flavor].max || -1;
      // Flavor not valid, so skip
      if (max_allowed <= 0 || current < 0) continue;  
      select.append(`<option value="${flavor}">${flavor}</option>`);
      
      let free = max_allowed - current;
      let description = "Dummy description";

      let diagramHtml = `
        <div class="row align-items-center g-0 mt-4">
          <div class="col-4">
            <span>${flavor}</span>
            <button class="btn" type="button" data-bs-toggle="collapse" data-bs-target="#${flavor}Info">
              {{ svg.info_filled_svg | safe }}
            </button>
            <div class="collapse" id="${flavor}Info">
              <div class="card card-body">${description}</div>
            </div>
          </div>
          <div class="progress col ms-2 fw-bold" style="height: 20px;">
            <div class="progress-bar" role="progressbar" style="width: ${current/max_allowed*100 || 0}%">${current} Used</div>
            <div class="progress-bar bg-success" role="progressbar" style="width: ${free/max_allowed*100 || 100}%">${free} Free</div>
          </div>
        </div>
      `
      $(`#${id}-flavor-info-div`).append(diagramHtml);
    }
    Object.keys(flavorsAllowed).length == 0 ? $(`#${id}-flavor-select-div, #${id}-flavor-info-div`).addClass("d-none") : $(`#${id}-flavor-select-div, #${id}-flavor-info-div`).removeClass("d-none");
    updateLabConfigSelect(select, value, currentVal);
  })
  .fail(function() {
    resetInputElement(select);
    $(`#${id}-flavor-info-div`).html("");
    $(`#${id}-flavor-select-div, #${id}-flavor-info-div`).addClass("d-none");
    updateLabConfigSelect(select, value, currentVal);
  });
}

function updateAccounts(id, service, system, value) {
  let select = $(`select#${id}-account-select`);
  const currentVal = select.val();
  resetInputElement(select);

  const accountsAllowed = (dropdownOptions[service] || {})[system] || {};
  for (const account of Object.keys(accountsAllowed).sort()) {
    select.append(`<option value="${account}">${account}</option>`);
  }
  Object.keys(accountsAllowed).length == 0 ? $(`#${id}-account-select-div`).addClass("d-none") : $(`#${id}-account-select-div`).removeClass("d-none");
  updateLabConfigSelect(select, value, currentVal);
}

function updateProjects(id, service, system, account, value) {
  let select = $(`select#${id}-project-select`);
  const currentVal = select.val();
  resetInputElement(select);

  const projectsAllowed = ( (dropdownOptions[service] || {}) [system] || {}) [account] || {};
  for (const project of Object.keys(projectsAllowed).sort()) {
    select.append(`<option value="${project}">${project}</option>`);
  }
  Object.keys(projectsAllowed).length == 0 ? $(`#${id}-project-select-div`).addClass("d-none") : $(`#${id}-project-select-div`).removeClass("d-none");
  updateLabConfigSelect(select, value, currentVal);
}

function updatePartitions(id, service, system, account, project, value) {
  const systemInfos = {{custom_config.get("systems") | tojson}};

  let select = $(`select#${id}-partition-select`);
  const currentVal = select.val();
  resetInputElement(select);
  // Distinguish between login and compute nodes
  var loginNodes = [];
  var computeNodes = [];
  const partitionsAllowed = ( ( (dropdownOptions[service] || {}) [system] || {}) [account] || {}) [project] || {};
  const interactivePartitions = (systemInfos[system] || {}).interactivePartitions || {};
  for (const partition of Object.keys(partitionsAllowed).sort()) {
    if ( interactivePartitions.includes(partition) ) loginNodes.push(partition);
    else computeNodes.push(partition);
  }
  // Append options to select in groups
  if (loginNodes.length > 0) {
    select.append('<optgroup label="Login Nodes">');
    loginNodes.forEach((x) => select.append(`<option value="${x}">${x}</option>`))
    select.append('</optgroup>');
  }
  if (computeNodes.length > 0) {
    select.append('<optgroup label="Compute Nodes">');
    const systemUpper = system.replace('-', '').toUpperCase();
    if ((systemsHealth[systemUpper] || 0) >= (systemsHealth.compute_threshold || 40) ) {
      computeNodes.forEach((x) => select.append(`<option value="${x}" disabled>${x} (in maintenance)</option>`));
    } 
    else {
      computeNodes.forEach((x) => select.append(`<option value="${x}">${x}</option>`));
    }
    select.append('</optgroup>');
  }
  Object.keys(partitionsAllowed).length == 0 ? $(`#${id}-partition-select-div`).addClass("d-none") : $(`#${id}-partition-select-div`).removeClass("d-none");
  updateLabConfigSelect(select, value, currentVal);
}

function updateReservation(id, service, system, account, project, partition, value) {
  const reservationInfos = {{auth_state.get("options_form").get("reservations") | tojson}} || {};

  let select = $(`select#${id}-reservation-select`);
  const currentVal = select.val();
  resetInputElement(select, required=false);

  const reservationsAllowed = ( ( ( (dropdownOptions[service] || {}) [system] || {}) [account] || {}) [project] || {}) [partition] || {};
  if (reservationsAllowed.length > 0 && JSON.stringify(reservationsAllowed) !== JSON.stringify(["None"])) {
    for (const reservation of reservationsAllowed) {
      if (reservation == "None") select.append(`<option value="${reservation}">${reservation}</option>`);
      else {
        const reservationName = reservation.ReservationName;
        const systemReservationInfos = reservationInfos[system] || {};
        for (const reservationInfo of systemReservationInfos) {
          if (reservationInfo.ReservationName == reservationName) {
            if (reservationInfo.State == "ACTIVE") select.append(`<option value="${reservationName}">${reservationName}</option>`);
            else select.append(`<option value="${reservationName}" disabled style="color: #6c757d;">${reservationName} [INACTIVE]</option>`);
          }
        }
      }
    }
    select.attr("required", true);
    $(`#${id}-reservation-select-div`).show();
    $(`#${id}-reservation-hr`).show();
  }
  else {
    $(`#${id}-reservation-select-div`).hide();
    $(`#${id}-reservation-hr`).hide();
  }
  updateLabConfigSelect(select, value, currentVal);
}

function updateResources(id, service, system, account, project, partition, nodes, gpus, runtime, xserver) {
  const resourceInfos = {{auth_state.get("options_form").get("resources") | tojson}} || {};
  let nodesInput = $(`input#${id}-nodes-input`);
  let gpusInput = $(`input#${id}-gpus-input`);
  let runtimeInput = $(`input#${id}-runtime-input`);
  let xserverCheckboxInput = $(`input#${id}-xcbserver-input`);
  let xserverInput = $(`input#${id}-xserver-input`);
  let tabWarning = $(`#${id}-resources-tab-warning`);
  const currentNodeVal = nodesInput.val();
  const currentGpusVal = gpusInput.val();
  const currentRuntimeVal = runtimeInput.val();
  const currentXserverCbVal = xserverCheckboxInput[0].checked;
  const currentXserverVal = xserverInput.val();
  [nodesInput, gpusInput, runtimeInput, xserverInput].forEach( input => resetInputElement(input, required=false));
  xserverCheckboxInput[0].checked = false;

  const systemResources = (resourceInfos[service] || {})[system] || {};
  if ($.isEmptyObject(systemResources)) {
    $(`#${id}-resources-tab`).addClass("disabled");
    tabWarning.addClass("invisible");
  }
  else {
    const partitionResources = systemResources[partition];
    if ($.isEmptyObject(partitionResources)) {
      $(`#${id}-resources-tab`).addClass("disabled");
      tabWarning.addClass("invisible");
    }
    else {
      $(`#${id}-resources-tab`).removeClass("disabled");
      if ("nodes" in partitionResources) {
        let min = (partitionResources.nodes.minmax || [0,1])[0];
        let max = (partitionResources.nodes.minmax || [0,1])[1];
        $(`label[for*=${id}-nodes-input]`).text("Nodes [" + min + "," + max + "]");
        let defaultNodes = partitionResources.nodes.default || 0;
        updateLabConfigInput(nodesInput, nodes, currentNodeVal, min, max, defaultNodes);
        $(`#${id}-nodes-input-div`).show();
        if (!currentNodeVal) tabWarning.removeClass("invisible");
      }
      else {
        $(`#${id}-nodes-input-div`).hide();
        if (currentNodeVal) tabWarning.removeClass("invisible");
      }

      if ("gpus" in partitionResources) {
        let min = (partitionResources.gpus.minmax || [0,1])[0];
        let max = (partitionResources.gpus.minmax || [0,1])[1];
        $(`label[for*=${id}-gpus-input]`).text("GPUs [" + min + "," + max + "]");
        let defaultGpus = partitionResources.gpus.default || 0;
        updateLabConfigInput(gpusInput, gpus, currentGpusVal, min, max, defaultGpus);
        $(`#${id}-gpus-input-div`).show();
        if (!currentGpusVal) tabWarning.removeClass("invisible");
      }
      else {
        $(`#${id}-gpus-input-div`).hide();
        if (currentGpusVal) tabWarning.removeClass("invisible");
      }

      if ("runtime" in partitionResources) {
        let min = (partitionResources.runtime.minmax || [0,1])[0];
        let max = (partitionResources.runtime.minmax || [0,1])[1];
        $(`label[for*=${id}-runtime-input]`).text("Runtime (minutes) [" + min + "," + max + "]");
        let defaultRuntime = partitionResources.runtime.default || 0;
        updateLabConfigInput(runtimeInput, runtime, currentRuntimeVal, min, max, defaultRuntime);
        $(`#${id}-runtime-input-div`).show();
        if (!currentRuntimeVal) tabWarning.removeClass("invisible");
      }
      else {
        $(`#${id}-runtime-input-div`).hide();
        if (currentRuntimeVal) tabWarning.removeClass("invisible");
      }

      if ("xserver" in partitionResources) {
        let cblabel = partitionResources.xserver.cblabel || "Activate XServer";
        $(`label[for*=${id}-xcbserver-input]`).text(cblabel);
        var min = (partitionResources.xserver.minmax || [0,1])[0];
        var max = (partitionResources.xserver.minmax || [0,1])[1];
        let label = partitionResources.xserver.label || "Use XServer GPU Index";
        $(`label[for*=${id}-xserver-input]`).text(label + " [" + min + "," + max + "]");

        if (xserver) { xserverCheckboxInput[0].checked = true; }
        else {
          xserver = partitionResources.xserver.default || 0;
          if (!currentXserverVal) tabWarning.removeClass("invisible");
          {#- Determine if XServer checkbox should be shown #}
          if (partitionResources.xserver.checkbox || false) {
            $(`#${id}-xcbserver-input-div`).show();
            if (currentXserverCbVal) xserverCheckboxInput[0].checked = true;
            else {
              if (partitionResources.xserver.default_checkbox || false)
                xserverCheckboxInput[0].checked = true;
              else xserverCheckboxInput[0].checked = false;
            }
            if (!currentXserverCbVal && xserverCheckboxInput[0].checked) tabWarning.removeClass("invisible");
          }
          else {
            $(`#${id}-xcbserver-input-div`).hide();
            xserverCheckboxInput[0].checked = true;
            if (!currentXserverCbVal) tabWarning.removeClass("invisible");
          }
        }
        updateLabConfigInput(xserverInput, xserver, currentXserverVal, min, max);
        if (xserverCheckboxInput[0].checked) $(`#${id}-xserver-input-div`).show();
        else $(`#${id}-xserver-input-div`).hide();
      }
      else {
        $(`#${id}-xcbserver-input-div`).hide();
        $(`#${id}-xserver-input-div`).hide();
        if (currentXserverCbVal || currentXserverVal) tabWarning.removeClass("invisible");
      }
    }
  }
}

function updateModules(id, service, system, account, project, partition, values) {
  const moduleInfos = {{custom_config.get("userModules", {}) | tojson}} || {};
  const systemInfos = {{custom_config.get("systems") | tojson}};
  const interactivePartitions = (systemInfos[system] || {}).interactivePartitions || {}; 

  const form = $(`#${id}-modules-form`);
  var tabWarning = $(`#${id}-modules-tab-warning`);
  var currentOptions = [];
  $(`#${id}-modules-form`).find(`input[type=checkbox]`).each(function () {
    currentOptions.push($(this).val());
  })
  
  var defaultOptions = [];
  var enableModulesTab = false;

  for (const [moduleSet, modules] of Object.entries(moduleInfos)) {
    $(`#${id}-${moduleSet}-div`).addClass("d-none");
    var insertIndex = -1;
    for (const [module, moduleInfo] of Object.entries(modules)) {
      if (moduleInfo.sets.includes(service)) {
        if (moduleInfo.allowedSystems && !moduleInfo.allowedSystems.includes(system)) {
          // Module not in allowed systems, so do nothing.
        }
        else {
          if (moduleInfo.compute_only && interactivePartitions.includes(partition) ) {
            // Module is compute only, but partition is interactive, so do nothing.
          }
          else {
            $(`#${id}-${moduleSet}-div`).removeClass("d-none");
            enableModulesTab = true;
            defaultOptions.push(module);
            // If checkbox already exists, do nothing
            // Else create it and set the default value
            if (!currentOptions.includes(module)) {
              let parent = $(`#${id}-${moduleSet}-checkboxes-div`);
              let checked = moduleInfo.default ? "checked" : "";
              {%- set module_cols = "col-sm-6 col-md-4 col-lg-3" %}
              let cbHtml = `
                <div id="${id}-${module}-cb-div" class="form-check {{module_cols}}">
                  <input type="checkbox" class="form-check-input" id="${id}-${module}-check" value="${module}" ${checked}>
                    <label class="form-check-label" for="${id}-${module}-check">
                      <span class="align-middle">${moduleInfo.displayName}</span>
                      <a href="${moduleInfo.href}" target="_blank" class="text-muted">{{ svg.info_svg | safe }}</a>
                    </label>
                  </input>
                </div>
              `
              // No checkboxes exist yet, so we can simply append to the parent div
              if (parent.children().length == 0) {
                parent.append(cbHtml);
              } 
              // Otherwise, we need to determine where to insert the new checkbox
              else {
                // Get the current element at index
                var target = parent.children().eq(insertIndex);
                target.before(cbHtml);
              }
              // Show tab warning to indicate changes in checkbox options
              tabWarning.removeClass("invisible");
            }
            insertIndex++;
          }
        }
      }
    }
  }
  // Remove checkboxes which still exist but should not anymore
  var shouldRemove = currentOptions.filter(x => !defaultOptions.includes(x));
  for (const module of shouldRemove) {
    $(`#${id}-${module}-cb-div`).remove();
    // Show tab warning to indicate changes in checkbox options
    tabWarning.removeClass("invisible");
  }

  // Set values according to previous values.
  if (values) {
    // Loop through all checkboxes and only check those in values.
    $(`#${id}-modules`).find("input[type=checkbox]").each((i, cb) => {
     if (values.includes(cb.value)) cb.checked = true;
     else cb.checked = false;
    })
  }
  
  if (enableModulesTab) $(`#${id}-modules-tab`).removeClass("disabled");
  else {
    $(`#${id}-modules-tab`).addClass("disabled");
    tabWarning.addClass("invisible");
  }
}
</script>

<script>
function getId(element, slice_index = -2) {
  var id_array = $(element).attr("id").split('-');
  var id = id_array.slice(0, slice_index).join('-');
  return id;
}

function getService(options) {
  if ("profile" in options)
    return options["profile"].split('/')[1];
  else 
    return options["service"].split('/')[1];
}

function getLabConfigSelectValues(id) {
  return {
    "service": $(`select#${id}-version-select`).val(),
    "system": $(`select#${id}-system-select`).val(),
    "account": $(`select#${id}-account-select`).val(),
    "project": $(`select#${id}-project-select`).val(),
    "partition": $(`select#${id}-partition-select`).val(),
  }
}

$("select[id*=version]").change(function() {
  const id = getId(this);
  const values = getLabConfigSelectValues(id);
  if (!$(this).hasClass("no-update")) {
    try { 
      updateSystems(id, values.service);
    }
    catch (e) { 
      setLabAsNA(id, "due to a JS error.");
      console.log(e);
    }
  }
});
$("select[id*=system]").change(function() {
  const id = getId(this);
  const values = getLabConfigSelectValues(id);
  if (!$(this).hasClass("no-update")) {
    try { 
      updateFlavors(id, values.service, values.system);
      updateAccounts(id, values.service, values.system);
    }
    catch (e) { 
      setLabAsNA(id, "due to a JS error.");
      console.log(e);
    }
  }

  // Check if the chosen version is deprecated for the system
  const serviceInfos = {{custom_config.get("services") | tojson}};
  const systemInfos = {{custom_config.get("systems") | tojson}} || {};
  // First check for system specific default option, then for general one
  var defaultOption = ((systemInfos[values.system].services || {}).JupyterLab || {}).defaultOption || serviceInfos.JupyterLab.defaultOption;
  if (defaultOption && values.service != defaultOption) {
    // Not using default/latest version, show a warning message
    let reason = "<span style=\"color:darkorange;\">uses deprecated version</span>";
    $(`#${id}-spawner-info`).removeClass("d-none").html(reason);
  }
  else {
    $(`#${id}-spawner-info`).addClass("d-none").html("");
  }
});
$("select[id*=account]").change(function() {
  const id = getId(this);
  const values = getLabConfigSelectValues(id);
  if (!$(this).hasClass("no-update")) {
    try { 
      updateProjects(id, values.service, values.system, values.account);
    }
    catch (e) {
      setLabAsNA(id, "due to a JS error.");
      console.log(e);
    }
  }
});
$("select[id*=project]").change(function() {
  const id = getId(this);
  const values = getLabConfigSelectValues(id);
  if (!$(this).hasClass("no-update")) {
    try { 
      updatePartitions(id, values.service, values.system, values.account, values.project);
    }
    catch (e) {
      setLabAsNA(id, "due to a JS error.");
      console.log(e);
    }
  }
});
$("select[id*=partition]").change(function() {
  const id = getId(this);
  const values = getLabConfigSelectValues(id);
  if (!$(this).hasClass("no-update")) {
    try { 
      updateReservation(id, values.service, values.system, values.account, values.project, values.partition);
      updateResources(id, values.service, values.system, values.account, values.project, values.partition);
      updateModules(id, values.service, values.system, values.account, values.project, values.partition);    }
    catch (e) {
      setLabAsNA(id, "due to a JS error.");
      console.log(e);
    }
  }
});
$("input[id*=xcbserver-input]").change(function() {
  const id = getId(this);
  const showXServer = $(`input#${id}-xcbserver-input`)[0].checked;
  if (showXServer) {
    $(`#${id}-xserver-input-div`).show();
  } else {
    $(`#${id}-xserver-input-div`).hide();
  }
});
$("select[id*=reservation]").change(function() {
  const reservationInfos = {{auth_state.get("options_form").get("reservations") | tojson}} || {};

  const id = getId(this);
  const value = $(this).val();
  if (value) {
    if (value == "None") {
      $(`#${id}-reservation-info-div`).hide();
      return;
    }
    const systemReservationInfos = reservationInfos[getLabConfigSelectValues(id)["system"]] || [];
    for (const reservationInfo of systemReservationInfos) {
      if (reservationInfo.ReservationName == value) {
        $(`#${id}-reservation-start`).html(reservationInfo.StartTime);
        $(`#${id}-reservation-end`).html(reservationInfo.EndTime);
        $(`#${id}-reservation-state`).html(reservationInfo.State);
        $(`#${id}-reservation-details`).html(
          JSON.stringify(reservationInfo, null, 2));
      }
    }
    $(`#${id}-reservation-info-div`).show();
  }
  else {
    $(`#${id}-reservation-info-div`).hide();
  }
});
$("input.module-selector").click(function() {
  const id = getId(this, slice_index=1);
  const allOrNone = $(this).attr("id").includes("select-all") ? "all" : "none";
  var checkboxes = $(`#${id}-modules-form`).find("input[type=checkbox]");
  if (allOrNone == "all") {
    $(`#${id}-modules-select-none`)[0].checked = false;
    checkboxes.each((i, cb) => { cb.checked = true; });
  }
  else if (allOrNone == "none") {
    $(`#${id}-modules-select-all`)[0].checked = false;
    checkboxes.each((i, cb) => { cb.checked = false; });
  }
})
</script>

<script>
function _appendToLog(htmlMsg, log) {
  try { htmlMsg = htmlMsg.replace(/&nbsp;/g, ' '); }
  catch (e) {
    // Not a valid htmlMsg
    return;
  }
  var exists = false;
  log.children().each( function (i, e) {
    let logMsg = $(e).html();
    if (htmlMsg == logMsg) exists = true;
  })
  if (!exists) log.append($('<div class="log-div">').html(htmlMsg));
}

function _updateProgressPercentage(id, text, progress) {
  var progressBar = $(`#${id}-progress-bar`);
  var progressInfo = $(`#${id}-progress-info-text`);
  progressBar.width(100).html(`<b>${progress}%</b>`);
  progressInfo.html(text);
}

function _updateProgressState(id, text, bg) {
  var progressBar = $(`#${id}-progress-bar`);
  var progressInfo = $(`#${id}-progress-info-text`);
  progressBar
    .width(100)
    .removeClass("bg-success bg-danger")
    .addClass(bg)
    .html("");
  progressInfo.html(text);
}

function checkComputeMaintenance(system, partition) {
  const systemInfos = {{custom_config.get("systems") | tojson}} || {};
  const interactivePartitions = (systemInfos[system] || {}).interactivePartitions || [];
  if (!interactivePartitions.includes(partition)) {
    const systemUpper = system.replace('-', '').toUpperCase();
    if ((systemsHealth[systemUpper] || 0) >= (systemsHealth.compute_threshold || 40)) return true;
    else return false;
  }
}

async function setSystemsHealth() {
  var incidentUrl = location.origin + window.jhdata.base_url + "api/incidents?_xsrf=" + window.jhdata.xsrf_token;
  var data = await $.get( incidentUrl );
  
  for (const entry in data) {
    {#- Thresholds #}
    if (entry.includes("threshold")) {
      systemsHealth[entry] = data[entry];
    } 
    {#- Systems #}
    else {
      systemsHealth[entry] = data[entry].health;
    }
  }
  return data;
}

function checkIfAvailable(id, options) {
  var reason = "due to ";
  var reason_broken_lab = "This lab is broken.\nPlease delete and recreate.";
  
  // Check if system is not available due to incident
  const systemUpper = options["system"].replace('-', '').toUpperCase();
  if ((systemsHealth[systemUpper] || 0) >= (systemsHealth.interactive_threshold || 50)) {
    reason += "maintenance";
    setLabAsNA(id, reason);
    return false;
  }

  // Check if system is not available due to groups
  const service = getService(options);
  const system = options["system"];
  const account = options["account"];
  const project = options["project"];
  const partition = options["partition"];
  const reservation = options["reservation"];
  const nodes = options["nodes"];
  const runtime = options["runtime"];
  const gpus = options["gpus"];
  const xserver = options["xserver"];

  if (service == undefined) {
    setLabAsNA(id, reason_broken_lab);
    return false;
  }
  if (!(service in dropdownOptions)) {
    reason += "service version";
    setLabAsNA(id, reason);
    return false;
  }
  if (system !== undefined) {
    if (dropdownOptions[service] == undefined) {
      setLabAsNA(id, reason_broken_lab);
      return false;
    }
    if (!(system in dropdownOptions[service])) {
      reason += "system";
      setLabAsNA(id, reason);
      return false;
    }
  }
  if (account !== undefined) {
    if (dropdownOptions[service][system] == undefined) {
      setLabAsNA(id, reason_broken_lab);
      return false;
    }
    if (!(account in dropdownOptions[service][system])) {
      reason += "account";
      setLabAsNA(id, reason);
      return false;
    }
  }
  if (project !== undefined) {
    if (dropdownOptions[service][system][account] == undefined) {
      setLabAsNA(id, reason_broken_lab);
      return false;
    }
    if (!(project in dropdownOptions[service][system][account])) {
      reason += "project";
      setLabAsNA(id, reason);
      return false;
    }
  }
  if (partition !== undefined) {
    if (dropdownOptions[service][system][account][project] == undefined) {
      setLabAsNA(id, reason_broken_lab);
      return false;
    }
    if (!(partition in dropdownOptions[service][system][account][project])) {
      reason += "partition";
      setLabAsNA(id, reason);
      return false;
    }
    // Only compute nodes are not available during rolling updates
    if (checkComputeMaintenance(system, partition)) {
      reason += "maintenance";
      setLabAsNA(id, reason);
      return false;
    }
  }
  if (reservation !== undefined && reservation != "None") {
    if (dropdownOptions[service][system][account][project][partition] == undefined) {
      setLabAsNA(id, reason_broken_lab);
      return false;
    }
    setFalse = true;
    for (const reservation_dict of dropdownOptions[service][system][account][project][partition]){
      if (reservation == reservation_dict.ReservationName)  {
        if (reservation_dict.State == "ACTIVE") {
          setFalse = false;
          break;
        }
      }
    }
    if (setFalse) {
      reason += "reservation";
      setLabAsNA(id, reason);
      return false;
    }
  }
  // Resources
  const resourceInfos = {{auth_state.get("options_form").get("resources") | tojson}} || {};
  const partitionResources = ( (resourceInfos[service] || {}) [system] || {}) [partition] || {};
  if (nodes !== undefined) {
    if (partitionResources.nodes == undefined) {
      setLabAsNA(id, reason_broken_lab);
      return false;
    }
    let min = (partitionResources.nodes.minmax || [0,1])[0];
    let max = (partitionResources.nodes.minmax || [0,1])[1];
    if (nodes < min || nodes > max) {
      reason += "number of nodes";
      setLabAsNA(id, reason);
      return false;
    }
  }
  if (gpus !== undefined) {
    if (partitionResources.gpus == undefined) {
      setLabAsNA(id, reason_broken_lab);
      return false;
    }
    let min = (partitionResources.gpus.minmax || [0,1])[0];
    let max = (partitionResources.gpus.minmax || [0,1])[1];
    if (gpus < min || gpus > max) {
      reason += "number of GPUs";
      setLabAsNA(id, reason);
      return false;
    }
  }
  if (runtime !== undefined) {
    if (partitionResources.runtime == undefined) {
      setLabAsNA(id, reason_broken_lab);
      return false;
    }
    let min = (partitionResources.runtime.minmax || [0,1])[0];
    let max = (partitionResources.runtime.minmax || [0,1])[1];
    if (runtime < min || runtime > max) {
      reason += "runtime";
      setLabAsNA(id, reason);
      return false;
    }
  }
  if (xserver !== undefined) {
    if (!("xserver" in partitionResources)) {
      reason += "XServer";
      setLabAsNA(id, reason);
      return false;
    }
  }

  return true;
}

function setLabAsNA(id, reason) {
  $(`#${id}-start-btn, #${id}-open-btn, #${id}-cancel-btn, #${id}-stop-btn`).addClass("d-none disabled");
  $(`#${id}-na-btn`).removeClass("d-none");
  $(`#${id}-na-status`).html(1);
  $(`#${id}-na-info`).removeClass("d-none").html(reason);
}

function setUserOptions(id, options, available) {
  const name = options["name"];
  const service = getService(options);
  const system = options["system"];
  const flavor = options["flavor"];
  const account = options["account"];
  const project = options["project"];
  const partition = options["partition"];
  const reservation = options["reservation"];
  const nodes = options["nodes"];
  const runtime = options["runtime"];
  const gpus = options["gpus"];
  const xserver = options["xserver"];
  const modules = options["userModules"];

  $(`#${id}-name-input`).val(name);
  if (available) {
    {#- Set allowed values. Do not rely on change events here as without
        passing a value explicitely, the first allowed option would be 
        chosen regardless of the user option value. #}
    try {
      updateService(id, service);
      updateSystems(id, service, system);
      updateFlavors(id, service, system, flavor);
      updateAccounts(id, service, system, account);
      updateProjects(id, service, system, account, project);
      updatePartitions(id, service, system, account, project, partition);
      updateReservation(id, service, system, account, project, partition, reservation);
      updateResources(id, service, system, account, project, partition, nodes, gpus, runtime, xserver);
      updateModules(id, service, system, account, project, partition, modules);
    }
    catch (e) { setLabAsNA(id, "due to a JS error."); }
  }
  else {
    function _setSelectOption(key, value) {
      if (value) $(`#${id}-${key}-select`).append(`<option value="${value}">${value}</option>`);
      updateLabConfigSelect($(`#${id}-${key}-select`), value);
    }

    function _setInputValue(key, value) {
      if (value) $(`#${id}-${key}-input`).val(value);
      else $(`#${id}-${key}-input-div`).hide();
    }

    $(`input[id*=${id}], select[id*=${id}]`).addClass("no-update");

    const serviceInfos = {{custom_config.get("services") | tojson}};
    var serviceName = (serviceInfos.JupyterLab.options[service] || {}).name || service;
    // Selects which are always visible
    $(`#${id}-version-select`).append(`<option value="${service}">${serviceName}</option>`);
    _setSelectOption("system", system);
    _setSelectOption("account", account);
    _setSelectOption("project", project);
    let maintenance = checkComputeMaintenance(system, partition);
    _setSelectOption("partition", maintenance ? `${partition} (in maintenance)` : partition);
    // Reservation
    var hasReservationInfo = false;
    if (reservation) {
      const systemReservationInfos = {{auth_state.get("options_form").get("reservations") | tojson}}[system] || [];
      for (const reservationInfo of systemReservationInfos) {
        if (reservationInfo.ReservationName == reservation) {
          hasReservationInfo = true;
          var inactive = reservationInfo.State == "INACTIVE";
          if (inactive) {
            $(`#${id}-reservation-select`).append(`<option value="${reservation}">${reservation} [INACTIVE]</option>`);
          }
          else {
            $(`#${id}-reservation-select`).append(`<option value="${reservation}">${reservation}</option>`);
          }
          $(`#${id}-reservation-select`).trigger("change");
        }
      }
      if (!hasReservationInfo) $(`#${id}-reservation-select`).append(`<option value="${reservation}">${reservation}</option>`);

    }
    else {
      $(`#${id}-reservation-select-div`).hide();
      $(`#${id}-reservation-hr`).hide();
    }
    if (hasReservationInfo) $(`#${id}-reservation-info-div`).show()
    else $(`#${id}-reservation-info-div`).hide();
    // Resources
    if ((nodes || runtime || gpus || xserver) !== undefined) {
      _setInputValue("nodes", nodes);
      _setInputValue("runtime", runtime);
      _setInputValue("gpus", gpus);
      {#- Don't have info about resources, so just never show the xserver checkbox #}
      _setInputValue("xserver", xserver);

    }
    else {
      $(`#${id}-resources-tab`).addClass("disabled");
    }
    // Modules
    updateModules(id, service, system, account, project, partition, modules);

    // Disable all user input elements if N/A
    $(`input[id*=${id}]`).attr("disabled", true);
    $(`select[id*=${id}]`).not("[id*=log]").addClass("disabled");
  }
}

function spawnStatusChanged(event) {
  const data = JSON.parse(event.data);

  // Create eventListeners for new labs if they don't exist
  for (const [id, pending] of Object.entries(data)) {
    if (!(id in spawnEvents)) {
      spawnEvents[id] = {"latest": []};
    }
    if (!(id in evtSources)) {
      // _updateSpawnEventsAndLog
      const startEvent = spawnEvents[id]["latest"][0];
      if (startEvent) {
        const startMsg = startEvent.html_message;
        var re = /([0-9]+(_[0-9]+)+).*[0-9]{2}:[0-9]{2}:[0-9]{2}(\\.[0-9]{1,3})?/;
        var startTime = re.exec(startMsg)[0];
        spawnEvents[id][startTime] = spawnEvents[id]["latest"];
        spawnEvents[id]["latest"] = [];
        $(`#${id}-log-select`)
          .append(`<option value="${startTime}">${startTime}</option>`)
          .val("latest");
      }
      let progressUrl = `${jhdata.base_url}api/users/${jhdata.user}/servers/${id}/progress?_xsrf=${window.jhdata.xsrf_token}`;
      evtSources[id] = new EventSource(progressUrl);
      evtSources[id].onmessage = function (e) {
        onEvtMessage(e, id);
      }
      // Reset progress bar and log for new spawns
      $(`#${id}-progress-bar`)
        .width(0).html("")
        .removeClass("bg-danger bg-success");
      $(`#${id}-progress-info-text`).html("");
      $(`#${id}-log`).html("");
      // Update buttons to reflect pending state
      let tr = $(`tr.summary-tr[data-server-id=${id}]`);
      // _enableTrButtonsRunning
      tr.find(".btn-na-lab, .btn-start-lab").addClass("d-none");
      tr.find(".btn-open-lab, .btn-cancel-lab").removeClass("d-none").addClass("disabled");
      }
  }
}

function onEvtMessage(event, id) {
  var tr = $(`.summary-tr[data-server-id=${id}]`);
  var collapsibleTr = $(`.collapsible-tr[data-server-id=${id}]`)
  var cancelBtn = tr.find(".btn-cancel-lab");
  var collapseBtns = collapsibleTr.find("button").not(".nav-link");

  var evt = JSON.parse(event.data);
  spawnEvents[id]["latest"].push(evt);
  if (evt.progress !== undefined && evt.progress != 0) {
    if (evt.progress == 100) {  // Spawn finished
      evtSources[id].close();
      delete evtSources[id];
      if (evt.failed) {  // Spawn failed
        _updateProgressState(id, "last spawn failed", "bg-danger");
        // Change buttons to start or N/A
        var na = tr.find(".na-status").text() || 0;
        if (na != "0") {
          tr.find(".btn-na-lab").removeClass("d-none")
          tr.find(".btn-start-lab").addClass("d-none");
        } 
        else {
          tr.find(".btn-na-lab").addClass("d-none");
          tr.find(".btn-start-lab").removeClass("d-none disabled");
        }
        tr.find(".btn-open-lab, .btn-cancel-lab").addClass("d-none disabled");
        collapseBtns.removeClass("disabled");
      }
      else if (evt.ready) {  // Spawn successful
        {%- for s in named_spawners %}
        if (id == "{{s.name}}") {
          {%- if not s._stop_pending %}
          _updateProgressState(id, "running", "bg-success");
          cancelBtn.addClass("d-none disabled");
          tr.find(".btn-stop-lab").removeClass("d-none disabled");
          tr.find(".btn-open-lab").removeClass("disabled");
          collapseBtns.removeClass("disabled");
          {%- endif %}
        }
        {%- endfor %}
      }
    }
    else { // Spawn in progress
      collapseBtns.addClass("disabled");
      if (evt.progress == {{cancel_progress_deactivation}}) {
        _updateProgressPercentage(id, "cancelling...", evt.progress);
        $(`#${id}-progress-bar`).addClass("bg-danger");
        cancelBtn.addClass("disabled");
      }
      else {
        _updateProgressPercentage(id, "spawning...", evt.progress);
        if (evt.progress >= {{cancel_progress_activation}} && evt.progress < {{cancel_progress_deactivation}}) {
          cancelBtn.removeClass("disabled");
        }
      }
    }    
  }

  if (evt.html_message !== undefined) {
    var htmlMsg = evt.html_message
  } else if (evt.message !== undefined) {
    var htmlMsg = evt.message;
  }
  if (htmlMsg) {
    // Only append if latest log is selected
    if ($(`#${id}-log-select`).val() == "latest")
      _appendToLog(htmlMsg, $(`#${id}-log`));
  }
}

function updateSpawnProgress() {
  {%- for s in named_spawners %}
  var id = "{{s.name}}";
  var latestEvents = spawnEvents["{{s.name}}"]["latest"] || [];
  // Append log messages
  for (const event of latestEvents) {
    _appendToLog(event["html_message"], $(`#${id}-log`));
  }
  // Add options to log select and select the latest log by default
  var logSelect = $(`#${id}-log-select`);
  for (const log in spawnEvents["{{s.name}}"]) {
    if (log == "latest") logSelect.prepend(`<option value="${log}">${log}</option>`);
    else logSelect.append(`<option value="${log}">${log}</option>`);
  }
  logSelect.val("latest");
  
  {%- if s.active %}
    {%- if s.ready %}
    _updateProgressState(id, "running", "bg-success");
    {%- elif not s._stop_pending %}
    var tr = $(`#${id}.summary-tr`);
    tr.find(".btn-open-lab").addClass("disabled");
    var currentProgress = 0;
    if (latestEvents.length > 0) {
      let lastEvent = latestEvents.slice(-1)[0];
      currentProgress = lastEvent.progress;
    }
    if (currentProgress < {{cancel_progress_activation}}
      || currentProgress >= {{cancel_progress_deactivation}}) {
      tr.find(".stop, .cancel").addClass("disabled");
    }
    // Disable the delete button during the spawn process.
    var collapse = $(`.collapsible-tr[data-server-id=${id}]`);
    collapse.find(".btn-delete-lab").addClass("disabled");
    // Update progress with percentage also
    _updateProgressPercentage(id, "spawning...", currentProgress);
    // Add an event listener to catch and display updates.
    var progressUrl = `${jhdata.base_url}api/users/${jhdata.user}/servers/${id}/progress?_xsrf=${window.jhdata.xsrf_token}`;
    evtSources[id] = new EventSource(progressUrl);
    {%- endif %}
  {%- elif s._failed or s._cancel_event_yielded %}
  var id = "{{s.name | safe}}";
  _updateProgressState(id, "last spawn failed", "bg-danger")
  {%- endif -%}

  {%- endfor %}

  for (const id in evtSources) {
    evtSources[id].onmessage = function (e) {
      onEvtMessage(e, id);
    }
  }
}

(async () => {
  await setSystemsHealth();
  for  (const id of Object.keys(userOptions)) {
    let available = checkIfAvailable(id, userOptions[id]);
    setUserOptions(id, userOptions[id], available);
  }
  updateSpawnProgress();

  {#- For new labs, only the first option has to be 
  updated manually. All other updates will be triggered
  via onChange and set default values. #}
  updateService("{{ new }}");
  $("#{{ new }}-log-select").prepend(`<option value="latest">latest</option>`);
})();

// Remove all tab warnings since initial changes shouldn't cause warnings
$("[id$=tab-warning]").addClass("invisible");

// Add event source for start and stop events
let notification_url = `${jhdata.base_url}api/users/${jhdata.user}/notifications/spawners/spawn?_xsrf=${window.jhdata.xsrf_token}`;
let spawnStatusChangedEvtSource = new EventSource(notification_url);
spawnStatusChangedEvtSource.onmessage = spawnStatusChanged;  // defined in handleServers.js
</script>

<script>
$("nav [id$=nav-item]").removeClass("active");
$("#start-nav-item, #collapse-start-nav-item").addClass("active");
</script>
{%- endblock -%}
