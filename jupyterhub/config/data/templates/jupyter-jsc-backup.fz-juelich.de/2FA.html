{% extends "jupyter-jsc-backup.fz-juelich.de/page.html" %}
{% if announcement_home %}
  {% set announcement = announcement_home %}
{% endif %}

{% block stylesheet %}
  <link rel="stylesheet" href="{{ static_url("css/pages/2FA.css", include_version=False) }}" type="text/css"/>
{% endblock %}


{% block main -%}

  <div class="content">
    <h2 class="">2-Factor Authentication for Jupyter-JSC
      <a role="button" class="btn btn-xl btn-warning" style="margin:0px 5px;float:right" href="nbviewer/github/FZJ-JSC/jupyter-jsc-notebooks/blob/master/001-Jupyter/Activate_JupyterJSC_2-factor-authentication.ipynb" target="_blank">Detailed Informations</a>
      {% if user -%}
        <a role="button" class="remove-2fa btn btn-xl btn-danger" style="margin:0px 5px;float:right" id="remove-2fa">Remove 2FA</a>
        <a role="button" class="activate-2fa btn btn-xl btn-start" style="margin:0px 5px;float:right" id="activate-2fa">Request 2FA</a>
      {% else -%}
        <a role="button" class="btn btn-xl btn-start" style="margin:0px 5px; float:right" href="/hub/oauth_login?next=2FA">Login required</a>
      {% endif -%}
    </h2>
    <div style="clear:both"></div>
    <div class="rest-container">
      <div class="rest" style="height: unset !important">
        <div class="image-text-container">
          <div class="image-container">
            <img src="{{ static_url("images/pages/2FA/img01.png", include_version=False) }}" title="2-factor-authentication"/> 
          </div>
          <div class="text-container">
            <h3>Preparation</h3>
            <p>2-Factor Authentication (2FA) better protects both your user credentials and the resources that you can access.
              Jupyter-JSC uses the time-based One-Time Password (OTP) generated by an OTP-App as a 2nd factor. </p>
            <ul>
              <li><b>Install an OTP-App</b>
                <p>On one of your personal devices (eg. your smartphone) install an OTP-App:</p>
                <ul>
                  <li><a href="https://freeotp.github.io" target="_blank"><b>FreeOTP</b></a> (iOS, Android)</li>
                  <li><a href="https://keeweb.info" target="_blank"><b>KeeWeb</b></a> (Linux, macOS, Windows, Online)</li>
                  <li>more alternatives can be found in <a href="https://jupyter-jsc-backup.fz-juelich.de/2fadetails" target="_blank">Detailed Informations</a></li>
                </ul>
              </li>
            </ul>
            <ul>
              <li><b>Initialize this OTP-App</b>
                <p>The required secret initialization code will be provided to you in the next step of this 2FA-activation process as a QR-Code (or string).
                  Then please scan the QR-code with your newly installed OTP-App (or type-in the string) for initialization.</p>
              </li>
            </ul>
          </div>
        </div>
       <div style="clear:both"></div>
        <div class="image-text-container">
          <div class="image-container">
            <img src="{{ static_url("images/pages/2FA/img03.png", include_version=False) }}" title="2-factor-authentication" width="200" style="float:left"/>
          </div>
          <div class="text-container">
            <h3>New two-step login</h3>
            <p>After you installed & initialized your <b>OTP-App</b> it will provide you (in our case every 30 seconds)
              with an unique <b>One-Time Password</b> whenever you want to login to Jupyter-JSC.</p> 
            <p>The 2FA-Login will be almost as simple as before</p> 
            <ul>
              <li><b>Enter your JSC-account password</b>
                <p>Each time you log in, you will enter your JSC-account password as usual.</p>
              </li>
              <li><b>Enter the current One-Time Password</b>
                <p>You will then be asked for an One-Time Password that you read from your installed and initialized OTP-App.</p>
              </li>
            </ul>
          </div>
        </div>
        <div style="clear:both"></div>
      </div>
    </div>
  </div>
{% endblock -%}

{% block script %}
{{ super() }}
<script type="text/javascript">
require(["home"]);
</script>
<script type="text/javascript">
    window.jhdata_code = {
        {% if code is defined %}
            code: true,
            code_success: "{{ code_success }}".toLowerCase() == "true",
            code_header: "{{ code_header}}",
            code_text: "{{ code_text }}",
        {% else %}
            code: false,
        {% endif %}
      }
    $(document).ready(function() {
    $(".resize-text").textfit('bestfit_min');
    $(".resize-text-min").textfit('bestfit_min');
    $(".resize-text-min-call").textfit('bestfit');
    var user = window.jhdata.user;
    var user_active = window.jhdata.user_active;
    var code = window.jhdata_code.code;
    if ( code ) {
      var code_success = window.jhdata_code.code_success;
      var code_header = window.jhdata_code.code_header;
      var code_text = window.jhdata_code.code_text;
      if ( code_success ) {
        $.confirm({
          title: "2-Factor Authentication - Activation",
          backgroundDismiss: 'Two factor authentication',
          content: "Activation successful.<br>Please re-login to initialize your 2nd factor.",
          buttons: {
            Ok: {
              text: "RE-LOGIN to initialize",
              btnClass: 'btn-blue',
              action: function() {
                window.location.replace("/hub/signout?stopall=false&alldevices=true");
              }
            },
            Cancel: {
              text: "LATER",
              btnClass: 'btn-default',
              action: function() {
              }
            }
          }
        });
      } else if ( code_text.includes('expired') ) {
        $.confirm({
          title: "2-Factor Authentication - Activation Failed",
          backgroundDismiss: 'Two factor authentication',
          content: "This activation link is not vaild anymore.<br>Please click \"Request 2FA\" for a new activation link.",
          buttons: {
            Ok: {
              text: "REQUEST 2FA",
              btnClass: 'btn-blue',
              action: function() {
                document.getElementById("activate-2fa").click();
              }
            },
            Cancel: {
              text: "Cancel",
              btnClass: 'btn-default',
              action: function() {
              }
            }
          }
        });
      } else {
        $.confirm({
          title: "2-Factor Authentication - Activation Failed",
          backgroundDismiss: 'Two factor authentication',
          content: "Code unknown.<br>Please try again with a new request or contact support.",
          buttons: {
            Ok: {
              text: "Ok",
              btnClass: 'btn-default',
              action: function() {
              }
            }
          }
        });
      }
    }
  });
</script>

<script src="{{static_url("js/pages/home.js", include_version=False) }}" type="text/javascript" charset="utf-8"></script>
<script src="{{static_url("js/pages/2FA.js", include_version=False) }}" type="text/javascript" charset="utf-8"></script>
{% endblock %}
