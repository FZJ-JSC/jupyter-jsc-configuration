{% extends "page.html" %}

{% block stylesheet %}
<link rel="stylesheet" href="{{ static_url("css/j4j_page_spawn_pending.min.css", include_version=False) }}" type="text/css"/>
<link rel="stylesheet" href="{{ static_url("css/j4j_progress_bar.min.css", include_version=False) }}" type="text/css"/>
{% endblock %}

{% block main %}


<div class="background-wrapper">
<div class="content">
      <input autocomplete="off" id="username" name="username" value="{{user.name}}" style="display:none">
      <input autocomplete="off" id="servername" name="servername" value="{{spawner.name}}" style="display:none">
    <div class="progress_row">
        <div class="progress_div">
            <div class="j4j_progress">
                <span class="j4j_progress-left">
                    <span class="j4j_progress-bar" id="pbleft"></span>
                </span>
                <span class="j4j_progress-right">
                    <span class="j4j_progress-bar" id="pbright"></span>
                </span>
                <div class="j4j_progress-value" id="sr-progress"></div>
            </div>
            <a id="cancel" role="button" class="btn btn-lg btn-danger">Cancel</a>
        </div>
        <div class="text_div">
          <p>Your server is starting up.</p>
          <p>You will be redirected automatically when it's ready for you.</p>
          <p id="progress-message">Submitting Job to UNICORE.</p>
          <div id="progress-log">
          </div>
        </div>
    </div>
</div>
</div>

{% endblock %}
{% block script %}
{{ super() }}
<script type="text/javascript" src="{{ static_url("js/j4j_spawn_pending.js", include_version=False) }}"></script>

<script type="text/javascript">
require(["jquery"], function ($) {
  $("#refresh").click(function () {
    window.location.reload();
  });
  // hook up event-stream for progress
  var evtSource = new EventSource("{{ progress_url }}");
  //console.log("{{ progress_url }}");
  var progressMessage = $("#progress-message");
  //var srProgress = $("#sr-progress");
  var progressLog = $("#progress-log");
  var cancelDoSomething = 0;
  var pathname = window.location.pathname;
  console.log("1");
  evtSource.onmessage = function(e) {
    console.log("2");
    var evt = JSON.parse(e.data);
    if (evt.progress !== undefined) {
      // update progress
      var progText = evt.progress.toString();
      moveBarTo(progText);
    }
    // update message
    var html_message;
    if (evt.html_message !== undefined) {
      progressMessage.html(evt.html_message);
      html_message = evt.html_message;
    } else if (evt.message !== undefined) {
      progressMessage.text(evt.message);
      html_message = progressMessage.html();
    }
    if (html_message) {
      progressLog.append(
        $("<div>")
          .addClass('progress-log-event')
          .html(html_message)
      );
    }
    if (evt.ready) {
      evtSource.close();
      // reload the current page
      // which should result in a redirect to the running server
      window.location.reload();
    }
    if (evt.failed) {
      evtSource.close();
      moveBarToFull(100, 0.2, true);
    }
  };

  var update = function (d1, d2) {
    $.map(d2, function (i, key) {
      d1[key] = d2[key];
    });
    return d1;
  };
  var ajax_defaults = function (options) {
    var d = {};
    update(d, default_options);
    update(d, options);
    return d;
  };

  var url_path_join = function () {
    var url = '';
    for (var i = 0; i < arguments.length; i++) {
      if (arguments[i] === '') {
        continue;
      }
      if (url.length > 0 && url[url.length-1] != '/') {
        url = url + '/' + arguments[i];
      } else {
        url = url + arguments[i];
      }
    }
    url = url.replace(/\/\/+/, '/');
    return url;
  };
  var encode_uri_components = function (uri) {
    return uri.split('/').map(encodeURIComponent).join('/');
  };

  $( document ).ready(function() {
    checkStatusEverySecond();
  });

  function checkStatusEverySecond(){
    interv = setInterval(checkStatus, 1000);
    function checkStatus() {
      var str = document.getElementById("sr-progress").innerHTML;
      var i = parseInt(str.substring(0, str.length-1));
      if ( i > 50 ) {
	cancelDoSomething = 1;
        $('#cancel').addClass("show-cancel");
	clearInterval(interv);
      }
    }
  }

  $("#cancel").click(function () {
    console.log("Hello cancel");
    if ( cancelDoSomething == 1 ) {
      var base_url = window.jhdata.base_url;
      var user = window.jhdata.user;
      var username = document.getElementById("username").value
      var servername = document.getElementById("servername").value
      console.log("Username: "+username)
      console.log("Servername: "+servername)
      options = { success: function () { location.assign('/') } };
      options = update(options, {type: 'DELETE', dataType: null});
      url = url_path_join(base_url, 'api', 'cancel', username, servername);
      console.log(url);
      $.ajax(url, options);
    }
  });
});
</script>
{% endblock %}
