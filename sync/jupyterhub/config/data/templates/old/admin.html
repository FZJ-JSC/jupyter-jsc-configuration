{% extends "page.html" %}
{% if announcement_home %}
  {% set announcement = announcement_home %}
{% endif %}

{% block stylesheet %}
<link rel="stylesheet" href="{{ static_url("css/j4j_page_home.min.css", include_version=False) }}" type="text/css"/>
{% endblock %}

{% macro th(label, key='', colspan=1) %}
<th data-sort="{{key}}" colspan="{{colspan}}">{{label}}
  {% if key %}
  <a href="#"><i class="fa {% if sort.get(key) == 'asc' -%}
                               fa-sort-asc
                           {%- elif sort.get(key) == 'desc' -%}
                               fa-sort-desc
                           {%- else -%}
                               fa-sort
                           {%- endif %} sort-icon">
  </i></a>
  {% endif %}
</th>
{% endmacro %}

{% block main %}

<div class="background-wrapper">
  <div class="content">
<a role="button" class="btn btn-xl btn-danger" id="logout-all">Logout all users</a>
    <div class="table-div" style="border-top: none;">
    <table class="table table-striped">
    <thead>
      <tr>
        {% block thead %}
        {{ th("User (%i)" % users|length, 'name') }}
        {{ th("Admin", 'admin') }}
        {{ th("Last Activity", 'last_activity') }}
        {{ th("Running (%i)" % running|length, 'running', colspan=2) }}
        {% endblock thead %}
      </tr>
    </thead>
    <tbody>
      <tr class="user-row add-user-row">
        <td colspan="12">
          <a id="add-users" role="button" class="col-xs-2 btn btn-default">Add Users</a>
          <span class="col-xs-offset-4 col-xs-3">
            <a id="start-all-servers" role="button" class="btn btn-primary col-xs-5 col-xs-offset-1">Start All</a>
            <a id="stop-all-servers" role="button" class="btn btn-danger col-xs-5 col-xs-offset-1">Stop All</a>
          </span>
          <a id="shutdown-hub" role="button" class="col-xs-2 col-xs-offset-1 btn btn-danger">Shutdown Hub</a>
        </td>
      </tr>
      {% for user in users %}
      {% for spawner in user.all_spawners() %}
      {% if spawner.active %}
      <tr class="user-row server-row" id="user-{{user.name}}" data-user="{{ user.name }}" data-server-name="{{spawner.name}}" data-admin="{{user.admin}}">
      {% block user_row scoped %}

      <td class="name-col col-sm-2">{{user.name}}
        {%- if spawner.name -%}
        /{{ spawner.name }}
        {%- endif -%}
      </td>

      <td class="admin-col col-sm-2">
        {%- if spawner.name == '' -%}
        {% if user.admin %}admin{% endif %}
        {%- endif -%}
      </td>

      <td class="time-col col-sm-3">
      {%- if spawner.last_activity -%}
        {{ spawner.last_activity.isoformat() + 'Z' }}
      {%- else -%}
        Never
      {%- endif -%}
      </td>

      <td class="server-col col-sm-2 text-center">
        <a role="button" class="stop-server btn btn-xs btn-danger{% if not spawner.active %} hidden{% endif %}">
        stop server
        </a>
        <a role="button" class="start-server btn btn-xs btn-primary{% if spawner.active %} hidden{% endif %}">
        start server
        </a>
      </td>
      <td class="server-col col-sm-1 text-center">
        {%- if admin_access %}
        <a role="button" class="access-server btn btn-xs btn-primary{% if not spawner.active %} hidden{% endif %}">
        access server
        </a>
        {%- endif %}
      </td>
      <td class="edit-col col-sm-1 text-center">
      {%- if spawner.name == '' -%}
        <a role="button" class="edit-user btn btn-xs btn-primary">edit user</a>
      {%- endif -%}
      </td>
      <td class="edit-col col-sm-1 text-center">
        {%- if spawner.name == '' -%}
        {#- user row -#}
          {%- if user.name != current_user.name -%}
          <a role="button" class="delete-user btn btn-xs btn-danger">delete user</a>
          {%- endif -%}
        {%- else -%}
          {#- named spawner row -#}
          <a role="button" class="delete-server btn btn-xs btn-warning">delete server</a>
        {%- endif -%}
      </td>
      </tr>
      {% endblock user_row %}
      {% endif %}
      {% endfor %}
      {% endfor %}
  </tbody>
  </table>
  </div>
  </div>
</div>
{% endblock %}

{% block script %}
{{ super() }}
<script type="text/javascript">
require(["home"]);
var input = document.getElementById("labname");
input.addEventListener("keyup", function(event) {
  if (event.keyCode === 13) {
   event.preventDefault();
   document.getElementById("labbutton").click();
  }
});
</script>
{% endblock %}
