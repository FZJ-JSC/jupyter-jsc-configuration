{%- extends template_path + "/page.html" %}

{%- block stylesheet -%}
  <link rel="stylesheet" href='{{static_url("css/home.css")}}' type="text/css"/>
  {# Vertical Tabs #}
  <link rel="stylesheet" href='{{static_url("components/bootstrap5/vertical-tabs/b5vtabs.min.css")}}'>
{%- endblock -%}


{%- set named_spawners = user.all_spawners(include_default=False) | list -%}
{%- set dropdown_lists = spawner_options_form.get("dropdown_lists") -%}
{%- set active_vo_config = custom_config.get("vos").get(auth_state.get("vo_active", ""), {}) -%} 
{%- set vo_services = active_vo_config.get("Services", {}) -%}
{%- set new = "new_jupyterlab" -%} {# id for new jupyterlabs #}


{%- macro table_actions(name, active, pending, service, option1, system, account, project, partition, reservation, runtime, nodes, gpus) -%}
{# Set config related variables #}
{%- set vo_allowed_list = vo_services.get(service, {}).get(option1, {}).get("replace_allowed_lists", {}) -%}
{%- set vo_resources = vo_services.get(service, {}).get(option1, {}).get("replace_resources", {}) -%}
{%- set service_allowed_list = custom_config.get("services").get(service, {}).get("options", {}).get(option1, {}).get("allowed_lists", {}) -%}

{# Logic to determine if a lab can be opened/started #}
{# If not a Lab from the current VO -- Not sure about this #}
{# {%- if auth_state.get("vo_active", "") != user_options.get("name").get("vo") -%} {%- set na = 1 -%} #}
{# System is in maintenance #}
{%- if system in maintenance_list -%} {%- set na = 1 -%}
{# System is not in replace_allowed_lists of the VO config #}
{%- elif "systems" in vo_allowed_list.keys()
   and system not in vo_allowed_list.get("systems", []) -%} {%- set na = 1 -%}
{# System not in allowed list of the services config and not overwritten in the VO config #}
{%- elif system not in service_allowed_list.get("systems", []) 
   and system not in vo_allowed_list.get("systems", []) -%} {%- set na = 1 -%}
{# Service or service option not allowed for active VO #}
{%- elif service not in vo_services.keys() or option1 not in vo_services.get(service, {}).keys() -%} {%- set na = 1 -%}
{# Account is not in replace_allowed_lists of the VO config #}
{%- elif "accounts" in vo_allowed_list.keys()
   and account not in vo_allowed_list.get("accounts", []) -%} {%- set na = 1 -%}
{# Project is not in replace_allowed_lists of the VO config #}
{%- elif "projects" in vo_allowed_list.keys()
   and project not in vo_allowed_list.get("projects", []) -%} {%- set na = 1 -%}
{# Project does not exist anymore for the system #}
{# {%- elif project != None 
   and project not in dropdown_lists.get("options", {}).get(option1, {}).get(system, {}).get(account, {}).keys() -%} {%- set na = 1 -%} #}
{# Partition is not in replace_allowed_lists of the VO config #}
{%- elif "partitions" in vo_allowed_list.keys()
   and partition not in vo_allowed_list.get("partitions", []) -%} {%- set na = 1 -%}
{# Reservation is not in replace_allowed_lists of the VO config #}
{%- elif "reservations" in vo_allowed_list.keys()
   and reservation not in vo_allowed_list.get("reservations", []) -%} {%- set na = 1 -%}
{# Runtime is smaller than min allowed runtime or greater than max allowed runtime as per the VO config #}
{%- elif "Runtime" in vo_resources.get(system, {}).get(partition, {}).keys() 
   and (
     (runtime|int / 60) < vo_resources.get(system, {}).get(partition, {}).get("Runtime", [[0,1], 0])[0][0] 
     or (runtime|int / 60) > vo_resources.get(system, {}).get(partition, {}).get("Runtime", [[0,1], 0])[0][1] 
   ) -%} {%- set na = 1 -%}
{# Number of nodes is smaller than min allowed number or greater than max allowed number as per the VO config #}
{%- elif "Nodes" in vo_resources.get(system, {}).get(partition, {}).keys() 
   and ( 
     (nodes|int) < vo_resources.get(system, {}).get(partition, {}).get("Nodes", [[0,1], 0])[0][0]
     or (nodes|int) > vo_resources.get(system, {}).get(partition, {}).get("Nodes", [[0,1], 0])[0][1] 
   ) -%} {%- set na = 1 -%}
{# Number of GPUS is smaller than min allowed number or greater than max allowed number as per the VO config #}
{%- elif "GPUS" in vo_resources.get(system, {}).get(partition, {}).keys() 
   and (
     (gpus|int) < vo_resources.get(system, {}).get(partition, {}).get("GPUS", [[0,1], 0])[0][0]
     or (gpus|int) > vo_resources.get(system, {}).get(partition, {}).get("GPUS", [[0,1], 0])[0][1] 
   ) -%} {%- set na = 1 -%}

{%- else -%} {%- set na = 0 -%}
{%- endif -%}

<div class="d-inline-flex justify-content-center">
  {%- set margin = "me-1"%}
  {# Save N/A status to page #}
  <span class="na-status d-none">{{na}}</span>
  {# N/A #}
  <button type="button" class="btn btn-secondary disabled {%- if na == 0 %} d-none {%- endif %} na {{margin}}">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-dash-circle-dotted" viewBox="0 0 16 16">
      <path d="M8 0c-.176 0-.35.006-.523.017l.064.998a7.117 7.117 0 0 1 .918 0l.064-.998A8.113 8.113 0 0 0 8 0zM6.44.152c-.346.069-.684.16-1.012.27l.321.948c.287-.098.582-.177.884-.237L6.44.153zm4.132.271a7.946 7.946 0 0 0-1.011-.27l-.194.98c.302.06.597.14.884.237l.321-.947zm1.873.925a8 8 0 0 0-.906-.524l-.443.896c.275.136.54.29.793.459l.556-.831zM4.46.824c-.314.155-.616.33-.905.524l.556.83a7.07 7.07 0 0 1 .793-.458L4.46.824zM2.725 1.985c-.262.23-.51.478-.74.74l.752.66c.202-.23.418-.446.648-.648l-.66-.752zm11.29.74a8.058 8.058 0 0 0-.74-.74l-.66.752c.23.202.447.418.648.648l.752-.66zm1.161 1.735a7.98 7.98 0 0 0-.524-.905l-.83.556c.169.253.322.518.458.793l.896-.443zM1.348 3.555c-.194.289-.37.591-.524.906l.896.443c.136-.275.29-.54.459-.793l-.831-.556zM.423 5.428a7.945 7.945 0 0 0-.27 1.011l.98.194c.06-.302.14-.597.237-.884l-.947-.321zM15.848 6.44a7.943 7.943 0 0 0-.27-1.012l-.948.321c.098.287.177.582.237.884l.98-.194zM.017 7.477a8.113 8.113 0 0 0 0 1.046l.998-.064a7.117 7.117 0 0 1 0-.918l-.998-.064zM16 8a8.1 8.1 0 0 0-.017-.523l-.998.064a7.11 7.11 0 0 1 0 .918l.998.064A8.1 8.1 0 0 0 16 8zM.152 9.56c.069.346.16.684.27 1.012l.948-.321a6.944 6.944 0 0 1-.237-.884l-.98.194zm15.425 1.012c.112-.328.202-.666.27-1.011l-.98-.194c-.06.302-.14.597-.237.884l.947.321zM.824 11.54a8 8 0 0 0 .524.905l.83-.556a6.999 6.999 0 0 1-.458-.793l-.896.443zm13.828.905c.194-.289.37-.591.524-.906l-.896-.443c-.136.275-.29.54-.459.793l.831.556zm-12.667.83c.23.262.478.51.74.74l.66-.752a7.047 7.047 0 0 1-.648-.648l-.752.66zm11.29.74c.262-.23.51-.478.74-.74l-.752-.66c-.201.23-.418.447-.648.648l.66.752zm-1.735 1.161c.314-.155.616-.33.905-.524l-.556-.83a7.07 7.07 0 0 1-.793.458l.443.896zm-7.985-.524c.289.194.591.37.906.524l.443-.896a6.998 6.998 0 0 1-.793-.459l-.556.831zm1.873.925c.328.112.666.202 1.011.27l.194-.98a6.953 6.953 0 0 1-.884-.237l-.321.947zm4.132.271a7.944 7.944 0 0 0 1.012-.27l-.321-.948a6.954 6.954 0 0 1-.884.237l.194.98zm-2.083.135a8.1 8.1 0 0 0 1.046 0l-.064-.998a7.11 7.11 0 0 1-.918 0l-.064.998zM4.5 7.5a.5.5 0 0 0 0 1h7a.5.5 0 0 0 0-1h-7z"/>
    </svg>
    N/A
  </button>
  {# Open #}
  {%- if na != 1 -%}
  <button type="button" class="btn btn-success open {%- if not active %} d-none {%- endif %} {{margin}}" data-server-url='/user/{{user.name}}/{{name}}'>
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
      <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
    </svg>
    Open
  </button>
  {%- endif -%}
  {# Cancel #}
  <button type="button" class="btn btn-danger cancel {%- if not active %} d-none {%- endif -%} 
    {%- if active and pending == None %} d-none {%- endif -%}">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stop-circle" viewBox="0 0 16 16">
      <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
      <path d="M5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5v-3z"/>
    </svg>
    Cancel
  </button>
  {# Stop #}
  <button type="button" class="btn btn-danger stop {%- if not active %} d-none {%- endif -%}
   {%- if active and pending != None %} d-none {%- endif -%}">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stop-circle" viewBox="0 0 16 16">
      <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
      <path d="M5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5v-3z"/>
    </svg>
    Stop
  </button>
  {# Start #}
  {%- if na != 1 -%}
  <button type="button" id="{{name}}-start-btn" class="btn btn-primary start {%- if active %} d-none {%- endif %} {{margin}}"
    href="{{base_url}}spawn/{{user.name}}/{{name}}" target="_blank">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16">
      <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"></path>
    </svg>
    Start
  </button>
  {%- endif -%}
</div>
{%- endmacro -%}

{%- macro vertical_tab(title, key, active=false) -%}
<li class="nav-item" role="presentation">
  <a id="{{key}}-tab" class="nav-link {%- if active %} active{%- endif -%}" 
    data-bs-toggle="tab" data-bs-target="#{{key}}" role="tab" aria-controls="{{key}}" aria-selected="true">
    <span class="align-middle pb-1">{{ title }}</span>
    <span id="{{key}}-tab-warning" class="badge rounded-pill bg-warning p-1 align-middle" style="display: none">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation" viewBox="0 0 16 16">
        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.553.553 0 0 1-1.1 0L7.1 4.995z"/>
      </svg>
      <span class="visually-hidden">settings changed</span>
    </span>
  </a>
</li>
{%- endmacro -%}

{%- macro tab_content(key, active=false, form=true) -%}
<div class="tab-pane fade {%- if active -%}show active{%- endif -%}" role="tabpanel"
  aria-labelledby="{{key}}-tab" id="{{key}}">
  {%- if form %}
  <form id="{{key}}-form">
    {{ caller() }}
  </form>
  {%- else -%}
  {{ caller() }}
  {%- endif %}
</div>
{%- endmacro -%}

{%- macro form_div(label, key, sm=2) -%}
{%- set key = key + "-" + label.lower() -%}
<div id="{{key}}-select-div" class="row mb-3">
  <label for="{{key}}-select" class="col-sm-{{sm}} col-form-label">
    <span class="align-middle">{{ label }}</span>
    <span id="{{key}}-warning" class="badge rounded-pill bg-warning p-1 align-middle" style="display: none">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation" viewBox="0 0 16 16">
        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.553.553 0 0 1-1.1 0L7.1 4.995z"/>
      </svg>
      <span class="visually-hidden">settings changed</span>
    </span>
  </label>
  <div class="col-sm-{{12-sm}}">
    <select id="{{key}}-select" class="form-select" required></select>
    <div class="invalid-feedback">
      Please choose a {{ label.lower() }}.
    </div>
  </div>
</div>
{%- endmacro -%}

{%- macro form_number_div(label, key) -%}
{%- set key = key + "-" + label.lower() -%}
<div id="{{key}}-input-div" class="row mb-3">
  <label for="{{key}}-input" class="col-sm-5 col-form-label">    
    <span id="{{key}}-text" class="align-middle">{{ label }}</span>
    <span id="{{key}}-warning" class="badge rounded-pill bg-warning p-1 align-middle" style="display: none">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation" viewBox="0 0 16 16">
        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.553.553 0 0 1-1.1 0L7.1 4.995z"/>
      </svg>
      <span class="visually-hidden">settings changed</span>
    </span>
  </label>
  <div class="col-sm-7">
    <input type="number" id="{{key}}-input" class="form-control" value="-1">
    <div class="invalid-feedback"></div>
  </div>
</div>
{%- endmacro -%}

{%- macro create_tr(name, display_name, active, pending, service, option1, system, account, project, partition, reservation, runtime, nodes, gpus) -%}
<tr data-server-name="{{name}}">
  <td class="details" data-bs-target="#{{name}}-collapse">
    <div class="d-flex mx-auto accordion-icon collapsed"></div>
  </td>
  <th scope="row">{{ display_name }}</th>
  <td class="system-td">{{ system }}</td>
  <td class="partition-td">
    {%- if partition == None %}
    <span class="text-muted">N/A</span>
    {%- else -%}
    {{ partition }}
    {%- endif %}
  </td>
  <td class="project-td">
    {%- if project == None %}
    <span class="text-muted">N/A</span>
    {%- else %}
    {{ project }}
    {%- endif %}
  </td>
  {%- set margin = "me-3"%}
  <td class="status-td">
    <div class="d-inline-flex flex-wrap align-items-center g-0">
      <div class="col-auto my-2">
        <div class="progress flex-grow-1 {{margin}}" style="height: 20px; min-width: 100px;">
          <div id="{{name}}-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
          aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div id="{{name}}-progress-info-text" class="progress-info-text text-muted text-center {{margin}}" style="font-size: smaller;"></div>
      </div>
      <div class="col-auto">
        <a class="progress-log-btn" role="button">
	        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16">
  	        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
          </svg>
        </a>
      </div>
    </div>
  </td>
   <td class="actions-td">{{ table_actions(name, active, pending, service, option1, system, account, project, partition, reservation, runtime, nodes, gpus) }}</td>
</tr>
{%- endmacro -%}

{%- macro create_tr_collapse(name, display_name) -%} {# Collapsed detailed information #}
<tr data-server-name="{{name}}" class="collapse-tr" style="--bs-table-accent-bg: transparent;">
  {# Remove padding from table data cell to hide the row when collapsed #}
  <td colspan=12 class="p-0">
    {# Do not add padding here as it messes up the transition #}
    <div class="collapse px-2" id="{{name}}-collapse">
      <div class="row collapse-row g-0 p-2">

        <div class="row g-0 mt-2">
          {# Vertical tabs #}
          <div class="col-md-3 col-xl-2">
            <ul class="nav nav-tabs left-tabs" role="tablist">
              {{ vertical_tab("Service", name + "-service", active=true) }}
              {{ vertical_tab("Options", name + "-options") }}
              {{ vertical_tab("Resources", name + "-resources") }}
              {{ vertical_tab("Reservation", name + "-reservation") }}
              {# {{ vertical_tab("Modules", name + "-modules") }} #}
              {# {{ vertical_tab("Kernel", name + "-kernel") }} #}
              {{ vertical_tab("Logs", name + "-logs") }}
              </li>
            </ul>
          </div>

          {# Vertical tab content #}
          <div class="col-md-9 col-xl-10">
            <div id="{{name}}-configuration" class="tab-content">
              {%- call tab_content(name + "-service", active=true) -%}
              <div class="row mb-3">
                <label for="{{name}}-name-input" class="col-sm-2 col-form-label">Name</label>
                <div class="col-sm-10">
                  <input type="name" class="form-control" id="{{name}}-name-input" value="{{display_name}}">
                </div>
              </div>
              {{ form_div("Type", name) }}
              {%- endcall -%}
              {%- call tab_content(name + "-options") -%}
              {{ form_div("System", name) }}
              {{ form_div("Account", name) }}
              {{ form_div("Project", name) }}
              {{ form_div("Partition", name) }}
              {%- endcall -%}
              {%- call tab_content(name + "-resources") -%}
              <form id="{{name}}-resources-form">
                {{ form_number_div("Nodes", name) }}
                {{ form_number_div("GPUs", name) }}
                {{ form_number_div("Runtime", name) }}
              </form>
              {%- endcall -%}
              {%- call tab_content(name + "-reservation") -%}
              {{ form_div("Reservation", name) }}
              {%- endcall -%}
              {%- call tab_content(name + "-modules") -%}
              {%- endcall -%}
              {%- call tab_content(name + "-kernel") -%}
              {%- endcall -%}
              {%- call tab_content(name + "-logs", form=False) -%}
                {{ form_div("Log", name) }}
                <div id="{{name}}-progress-log" class="card card-body"></div>
              {%- endcall -%}
            </div>
          </div>
        </div>

        {# Vertical line #}
        <div class="col-md-3 col-xl-2" style="border-right: 1px solid #dee2e6"></div>

        {# Edit buttons #}
        <div class="col-md-9 col-xl-10 mb-3 px-3">
        <hr>
          <div class="d-flex align-items-center">
            <button  id="{{name}}-save-btn" class="btn btn-success save me-2" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-save" viewBox="0 0 16 16">
                <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
              </svg>
              <span class="align-middle">Save</span>
            </button>
            <button id="{{name}}-reset-btn" class="btn btn-danger reset me-2" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-counterclockwise" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/>
                <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/>
              </svg>
              <span class="align-middle">Reset</span>
            </button>
            <div class="alert fade pe-none mb-0 p-2" role="alert">
              <span class="align-middle"></span>
              <button type="button" class="btn-close align-middle" onClick="$(this).parent().removeClass('show'); $(this).parent().addClass('pe-none');"></button>
            </div>
            <button type="button" class="btn btn-danger delete ms-auto">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
              </svg>
              Delete Lab
            </button>
          </div>
        </div>

      </div> {# End of row div of collapse #}
    </div> {# End of collapse div #}
  </td>
</tr>
{%- endmacro -%}

{%- block main -%}
<div class="p-4">
  <div class="d-flex align-items-center fs-1 mb-3">
    JupyterLabs
    <button class="btn btn-primary btn-lg new ms-3" data-bs-toggle="modal" data-bs-target="#{{new}}-dialog">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
        <path d="M8 0a1 1 0 0 1 1 1v6h6a1 1 0 1 1 0 2H9v6a1 1 0 1 1-2 0V9H1a1 1 0 0 1 0-2h6V1a1 1 0 0 1 1-1z"/>
      </svg>
      <span class="align-middle">New</span>
    </button>
  </div>

  <p>You can configure your existing JupyterLabs by expanding the corresponding table row.</p>

  {# New Jupyterlab Dialog #}
  <div class="modal fade text-black" id="{{new}}-dialog" tabindex="-1" aria-labelledby="{{new}}-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="{{new}}-label">Configuration</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row mt-2">
            {# Vertical tabs #}
            <div class="col-3">
              <ul class="nav nav-tabs left-tabs" role="tablist">
                {{ vertical_tab("Service", new + "-service", active=true) }}
                {{ vertical_tab("Options", new + "-options") }}
                {{ vertical_tab("Resources", new + "-resources") }}
                {{ vertical_tab("Reservation", new + "-reservation") }}
                {# {{ vertical_tab("Modules", new + "-modules") }} #}
                {# {{ vertical_tab("Kernel", new + "-kernel") }} #}
                </li>
              </ul>
            </div>

            {# Vertical tab content #}
            <div class="col-9">
              <div id="{{new}}-configuration" class="tab-content pt-0">
                {%- call tab_content(new + "-service", active=true) -%}
                <div class="row mb-3">
                  <label for="{{new}}-name-input" class="col-sm-3 col-form-label">
                    Name
                    <span id="{{new}}-name-warning" class="badge rounded-pill bg-warning p-1 align-middle" style="display: none">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation" viewBox="0 0 16 16">
                        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.553.553 0 0 1-1.1 0L7.1 4.995z"/>
                      </svg>
                      <span class="visually-hidden">name missing</span>
                    </span>
                  </label>
                  <div class="col-sm-9">
                    <input type="name" class="form-control" id="{{new}}-name-input" 
                      maxlength="30" placeholder="Please give your configuration a name.">
                    <div class="invalid-feedback">
                      <b>Your name is too long, max=30.</b>
                    </div>
                  </div>
                </div>
                {{ form_div("Type", new, sm=3) }}
                {%- endcall -%}

                {%- call tab_content(new + "-options") -%}
                {{ form_div("System", new, sm=3) }}
                {{ form_div("Account", new, sm=3) }}
                {{ form_div("Project", new, sm=3) }}
                {{ form_div("Partition", new, sm=3) }}
                {%- endcall -%}

                {%- call tab_content(new + "-resources") -%}
                <form id="{{new}}-resources-form">
                  {{ form_number_div("Nodes", new) }}
                  {{ form_number_div("GPUs", new) }}
                  {{ form_number_div("Runtime", new) }}
                </form>
                {%- endcall -%}

                {%- call tab_content(new + "-reservation") -%}
                {{ form_div("Reservation", new, sm=3) }}
                {%- endcall -%}

                {%- call tab_content(new + "-modules") -%}
                {%- endcall -%}

                {%- call tab_content(new + "-kernel") -%}
                {%- endcall -%}
              </div>
            </div>
          </div>
        </div>          
        <div class="modal-footer">
          <div class="alert fade mb-0 p-2" role="alert">
            <span class="align-middle"></span>
            <button type="button" class="btn-close align-middle" onClick="$(this).parent().removeClass('show');"></button>
          </div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="{{new}}-start-btn" class="btn btn-primary">
            Start
            <div class="spinner-border spinner-border-sm text-light d-none" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>
 
  {# Table with existing JupyterLabs #}
  <div class="table-responsive">
    <table id="jupyterlabs-table" class="table table-bordered table-hover table-light align-middle">
      <thead class="table-secondary">
        <tr>
          <th scope="col"></th> {# Open/close details #}
          <th scope="col">Name</th>
          <th scope="col">System</th>
          <th scope="col">Partition</th>
          <th scope="col">Project</th>
          <th scope="col" style="width: 275px;">Status</th> {# Status #}
          <th scope="col" style="width: 210px;">Actions</th> {# Actions #}
        </tr>
      </thead>
      <tbody>
        {%- set tbody_ns = namespace(table_has_rows=false) -%}
        {%- for s in named_spawners -%}
        {%- set spawner = s.orm_spawner -%}
        {%- set user_options = spawner.user_options -%}
        {%- if user_options -%}
        {# {{user_options}} #}
        {%- set display_name = user_options.get("name") -%}
        {%- set service = user_options.get("service").split('/')[0] -%}
        {%- set option = user_options.get("service").split('/')[1] -%}
        {%- set system = user_options.get("system", None) -%}
        {%- set account = user_options.get("account", None) -%}
        {%- set project = user_options.get("project", None) -%}
        {%- set partition = user_options.get("partition", None) -%}
        {%- set reservation = user_options.get("reservation", None) -%}
        {%- set nodes = user_options.get("nodes", None) -%}
        {%- set runtime = user_options.get("runtime", None) -%}
        {%- set gpus = user_options.get("gpus", None) -%}
        {# Exclude dashboards #}
        {%- if service != "Dashboard"  -%}
        {{ create_tr(spawner.name, display_name, s.active, s.pending, service, option, system, account, project, partition, reservation, runtime, nodes, gpus) }}
        {{ create_tr_collapse(spawner.name, display_name) }}
        {%- set tbody_ns.table_has_rows = True -%}
        {%- endif -%}
        {%- endif -%}
        {%- endfor -%}
        {%- if not tbody_ns.table_has_rows -%}
        <tr>
          <td></td>
          <td colspan="5%" class="fst-italic text-muted">No JupyterLabs configured yet.<td>
        </tr>
        {%- endif -%}
      </tbody>
    </table>
  </div>
</div>
{%- endblock -%}


{%- block script -%}
<script>
// Make user_options and spawn events globally available in JS
var user_options = {};
var spawn_events = {}
{%- for s in named_spawners -%}
{%- set spawner = s.orm_spawner -%}
{%- set user_options = spawner.user_options -%}
  {%- if user_options and user_options.get("service").startswith("JupyterLab") %}
  user_options["{{spawner.name}}"] = {{ user_options | tojson }}
  {%- endif -%}
  {%- if spawner.state and spawner.state.get("events") %}
  spawn_events["{{spawner.name}}"] = {{ spawner.state.get("events") | tojson }};
  {%- else %}
  spawn_events["{{spawner.name}}"] = {"latest": []};
  {%- endif -%}
{%- endfor %}


var spawner_options_form = {{spawner_options_form | tojson}}
</script>

<script>
/* Callbacks for new JupyterLabs */
$(document).ready(function () {
  // New jupyterlabs
  $("#{{new}}-name-input").val(""); // Reset name
  updateOption1("{{new}}"); // Trigger dropdown option updates
  $("#{{new}}-name-input").addClass("border-warning");
  $("#{{new}}-name-warning").show();
  // Trigger warning badge in service tab of new lab configuration
  $("#{{new}}-service-tab-warning")[0].dispatchEvent(new Event("change"));

  // Disable start if there are no systems available
  var first_option = $("#{{new}}-system-select").children().first();
  if (first_option.prop("disabled")) {
    $("#{{new}}-start-btn").addClass("disabled");
    $("#{{new}}-options-tab").addClass("disabled");
  }
})

// Reset all dropdowns after closing the new jupyterlab dialog
$("#{{new}}-dialog").on('hidden.bs.modal', function (event) {
  // Reset name
  $("#{{new}}-name-input").val("");
  // Reset all dropdowns and inputs
  $("#{{new}}-dialog").find("select, input").each(function() {
    $(this).val(null);
  })

  // Trigger dropdown option updates
  updateOption1("{{new}}"); 
  $("#{{new}}-name-input").addClass("border-warning");
  $("#{{new}}-name-warning").show();
  // Trigger warning badge in service tab of new lab configuration
  $("#{{new}}-service-tab-warning")[0].dispatchEvent(new Event("change"));

  // Show first tab after resetting values
  var trigger = $("#{{new}}-service-tab");
  var tab = new bootstrap.Tab(trigger);
  tab.show();
})
</script>

<script>
/* Set initial values */
function setValues(name, options) {
  var id = name;
  var option1 = options["service"].split('/')[1];
  var system = options["system"];
  var account = options["account"];
  var project = options["project"];
  var partition = options["partition"];
  var reservation = options["reservation"];
  var nodes = options["nodes"];
  var runtime = options["runtime"];
  var gpus = options["gpus"];

  if (!account) account = "None";
  if (!project) project = "None";
  if (!partition) partition = "None";
  if (!reservation) reservation = "None";

  // Need to run all updates manually to set the correct initial values
  updateOption1(id, option1);
  updateSystems(id, option1, system);
  updateAccounts(id, option1, system, account);
  updateProjects(id, option1, system, account, project);
  updatePartitions(id, option1, system, account, project, partition);
  updateResources(id, option1, system, account, project, partition, reservation);
  // updateResources only sets reservation value, so update other resources manually
  if (nodes) $("input#" + id + "-nodes-input").val(nodes);
  if (runtime) {
    let runtime_minutes = runtime/60;
    $("input#" + id + "-runtime-input").val(runtime_minutes);
  }
  if (gpus) $("input#" + id + "-gpus-input").val(gpus);
}

$(document).ready(function () {
  // Set values for all existing Labs
  for (const [name, options] of Object.entries(user_options)) {
    setValues(name, options);
    removeWarnings(name); // Remove all warning badges
  }

  $("tr[data-server-name]").not(".collapse-tr").each(function () {
    var na = $(this).find(".na-status").text();
    if ( na == 1 ) {
      $(this).addClass("text-muted");
      $(this).find(".btn").not(".btn[id*=log-btn]").attr("disabled", true);
    }
  })

  // Disable edit buttons again
  $(".save").attr("disabled", true);
  $(".reset").attr("disabled", true);

  // Update spawners in table if they are currently running or their spawn is pending
  // Update logs for all spawners if log exists
  updateSpawners();
})
</script>

<script>
function get_id(element) {
  var id_array = element.attr("id").split('-');
  var id = id_array.slice(0,-2).join('-');
  return id;
}

/* On user chaning JupyterLab configurations */
$("select[id*=type]").change(function() {
  var id = get_id($(this));
  var option = $(this).val();
  updateSystems(id, option);
});

$("select[id*=system]").change(function() {
  var id = get_id($(this));
  var option = $("select#" + id + "-type-select").val();
  var system = $(this).val();
  updateAccounts(id, option, system);
});

$("select[id*=account]").change(function() {
  var id = get_id($(this));
  var option = $("select#" + id + "-type-select").val();
  var system = $("select#" + id + "-system-select").val();
  var account = $(this).val();
  updateProjects(id, option, system, account);
});

$("select[id*=project]").change(function() {
  var id = get_id($(this));
  var option = $("select#" + id + "-type-select").val();
  var system = $("select#" + id + "-system-select").val();
  var account = $("select#" + id + "-account-select").val();
  var project = $(this).val();
  updatePartitions(id, option, system, account, project);
});

$("select[id*=partition]").change(function() {
  var id = get_id($(this));
  var option = $("select#" + id + "-type-select").val();
  var system = $("select#" + id + "-system-select").val();
  var account = $("select#" + id + "-account-select").val();
  var project = $("select#" + id + "-project-select").val();
  var partition = $(this).val();
  updateResources(id, option, system, account, project, partition);
});

$("select[id*=log]").change(function() {
  var id = get_id($(this));
  var selected = $(this).val();
  const selected_log = spawn_events[id][selected];
  // Replace progress log with selcted log
  var progress_log = $("#" + id + "-progress-log");
  progress_log.html("");
  for (const log in selected_log) {
    var html_message = selected_log[log].html_message;
    no_duplicate_log(html_message, progress_log);
  }
});
</script>

<script>
/* Functions handling changes in JupyterLab configurations */

function updateOption1(id, value=null) {
  var select = $("select#" + id + "-type-select");
  var values = []
  var old_value = select.val();

  select.html("");
  {%- for option in spawner_options_form.get('dropdown_lists', {}).get('options', {}).keys() | unique %}
    select.append('<option value="{{option}}">{{ custom_config.get("services").get("JupyterLab").get("options").get(option).get("name") }}</option>');
    values.push("{{option}}");
  {%- endfor %}
  updateSelect(select, id, value, old_value, values, tab_id="service");
}

function updateSystems(id, option, value=null) {
  var select = $("select#" + id + "-system-select");
  var values = []
  var old_value = select.val();

  select.html("");
  {%- for option, systems_allowed in spawner_options_form.get("dropdown_lists", {}).get("options", {}).items() %}
  if (option == {{ option | tojson }}) {
    {%- for system in spawner_options_form.get("dropdown_lists", {}).get("systems", []) %}
      {%- if system in systems_allowed.keys() %}
      select.append('<option value="{{system}}">{{ system }}</option>');
      values.push("{{system}}");
      {%- endif %}
    {%- endfor %}
  }
  {%- endfor %}
  updateSelect(select, id, value, old_value, values);
}

function updateAccounts(id, option, system, value=null) {
  var select = $("select#" + id + "-account-select");
  var values = []
  var old_value = select.val();

  select.html("");
  select.removeClass("text-muted");
  select.attr("required", true);
  {%- for option, systems_allowed in spawner_options_form.get("dropdown_lists", {}).get("options", {}).items() %}
    {%- for system, accounts_allowed in systems_allowed.items() %}
      {%- if spawner_options_form.get('dropdown_lists').get('accounts', {}).get(system, []) | length > 0 %} 
      if (option == {{ option | tojson }} && system == {{ system | tojson }}) {
        {%- for account in spawner_options_form.get('dropdown_lists', {}).get('accounts', {}).get(system, []) | unique | sort %}
          {%- if account in accounts_allowed.keys() %}
          select.append('<option value="{{account}}">{{ account }}</option>');
          values.push("{{account}}");
          {%- endif %}
        {%- endfor %}
      }
      {%- endif %}
    {%- endfor %}  
  {%- endfor %}
  updateSelect(select, id, value, old_value, values);
}

function updateProjects(id, option, system, account, value=null) {
  var select = $("select#" + id + "-project-select");
  var values = []
  var old_value = select.val();
  
  select.html("");
  select.removeClass("text-muted");
  select.attr("required", true);
  {%- for option, systems_allowed in spawner_options_form.get('dropdown_lists', {}).get('options', {}).items() %}
    {%- for system, accounts_allowed in systems_allowed.items() %}
      {%- for account, projects_allowed in accounts_allowed.items() %}
        {%- if spawner_options_form.get('dropdown_lists').get('projects', {}).get(system, {}).get(account, []) | length > 0 %} 
        if (option == {{ option | tojson }} && system == {{ system | tojson }} && account == {{ account | tojson }}) {
          {%- for project in spawner_options_form.get('dropdown_lists', {}).get('projects', {}).get(system, {}).get(account, []) | unique | sort %}
            {%- if project in projects_allowed.keys() %}
            select.append('<option value="{{project}}">{{ project }}</option>');
            values.push("{{project}}");
            {%- endif %}
          {%- endfor %}
        }
        {%- endif %}
      {%- endfor %} {# account #}
    {%- endfor %} {# system #}
  {%- endfor %} {# option #}
  updateSelect(select, id, value, old_value, values);
}

function updatePartitions(id, option, system, account, project, value=null) {
  var select = $("select#" + id + "-partition-select");
  var warning = $("#" + id + "-partition-warning");
  var values = []
  var old_value = select.val();

  select.html("");
  select.removeClass("text-muted");
  select.attr("required", true);
  // Distinguish between login and compute nodes
  var login_nodes = []
  var compute_nodes = []
  {%- for option, systems_allowed in spawner_options_form.get('dropdown_lists', {}).get('options', {}).items() %}
    {%- for system, accounts_allowed in systems_allowed.items() %}
      {%- for account, projects_allowed in accounts_allowed.items() %}
        {%- for project, partitions_allowed in projects_allowed.items() %}
          {%- if spawner_options_form.get('dropdown_lists').get('partitions', {}).get(system, {}).get(account, {}).get(project, []) | length > 0 %}
          if (option == {{ option | tojson }} && system == {{ system | tojson }} && account == {{ account | tojson }} && project == {{ project | tojson }}) {
            {%- for partition in spawner_options_form.get('dropdown_lists', {}).get('partitions', {}).get(system, {}).get(account, {}).get(project, []) | unique %}
              {%- if partition in partitions_allowed.keys() %}
              values.push("{{partition}}");
              {%- set systems = custom_config.get("systems") -%}
              var interactive_partitions = {{ systems.get(system).get("interactive_partitions", []) | tojson }}
              if ( interactive_partitions.includes("{{partition}}") ) {
                login_nodes.push("{{partition}}");
              } else compute_nodes.push("{{partition}}");
              {%- endif %}
            {%- endfor %}
          }
          {%- endif %}
        {%- endfor %} {# project #}
      {%- endfor %} {# account #}
    {%- endfor %} {# system #}
  {%- endfor %} {# option #}

  if (login_nodes.length > 0) {
    select.append('<optgroup label="Login Nodes">');
    login_nodes.forEach((x) => select.append(`<option value="${x}">${x}</option>`))
    select.append('</optgroup>');
  }
  if (compute_nodes.length > 0) {
    select.append('<optgroup label="Compute Nodes">');
    compute_nodes.forEach((x) => select.append(`<option value="${x}">${x}</option>`))
    select.append('</optgroup>');
  }
  updateSelect(select, id, value, old_value, values);
}

function updateResources(id, option, system, account, project, partition, reservation_value=null) {
  var nodes_input = $("input#" + id + "-nodes-input");
  var gpus_input = $("input#" + id + "-gpus-input");
  var runtime_input = $("input#" + id + "-runtime-input");
  var reservation_select = $("select#" + id + "-reservation-select");
  // Save old values
  var old_resource_values = {
    "nodes": nodes_input.val(),
    "gpus": gpus_input.val(),
    "runtime": runtime_input.val(),
  }
  var old_reservation_value = reservation_select.val();
  var reservation_values = [];
  var reservation = null;
  // Reset all values
  var resources = [nodes_input, gpus_input, runtime_input, reservation_select];
  resources.forEach(function(resource) {
    resource.val(null);
    resource.removeAttr("required");
  });
  reservation_select.html("");
  // Disable tabs
  var resource_tab = $("#" + id + "-resources-tab");
  var reservation_tab = $("#" + id + "-reservation-tab");
  var should_show = false;
  resource_tab.addClass("disabled");
  reservation_tab.addClass("disabled");

  {%- for option, systems_allowed in spawner_options_form.get('dropdown_lists', {}).get('options', {}).items() %}

    console.log({{systems_allowed|tojson}})

    {%- for system, accounts_allowed in systems_allowed.items() %}

    console.log({{system|tojson}})

      {%- for account, projects_allowed in accounts_allowed.items() %}

         console.log({{account|tojson}})

        {%- for project, partitions_allowed in projects_allowed.items() %}
          {%- for partition, reservations_allowed in partitions_allowed.items() %}

          if (system == "HDF-Cloud" && {{system|tojson}} == "HDF-Cloud") {
            console.log("before if")
            console.log("system:", system, {{system|tojson}})
            console.log("account:", account, {{account|tojson}})
            console.log("partition:", partition, {{partition|tojson}})
          }

          if (option == {{ option | tojson }} && system == {{ system | tojson }} && account == {{ account | tojson }} && project == {{ project | tojson }} && partition == {{ partition | tojson }}) {
            
            console.log("in if")
            
            {%- if "nodes" in spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}) %}
            var min = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("nodes", {}).get("minmax", [0, 1])[0] }};
            var max = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("nodes", {}).get("minmax", [0, 1])[1] }};
            if (user_options[id] && user_options[id]["nodes"]) {
              var value = user_options[id]["nodes"];
            } else
              var value = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("nodes", {}).get("default", 0) }};

            $("#" + id + "-nodes-text").text("Nodes [" + min + "," + max + "]");
            nodes_input.attr({"min": min, "max": max, "value": value});
            nodes_input.val(value);
            nodes_input.attr("required", true);
            // Set message for invalid feedback
            nodes_input.siblings(".invalid-feedback").text(`Please choose a number between ${min} and ${max}.`);
            updateInput(id, old_resource_values["nodes"], value, min, max, nodes_input);
            $("#" + id + "-nodes-input-div").show();
            var should_show = true;
            {%- else %}
            $("#" + id + "-nodes-input-div").hide();
            // Show warning even if the div is hidden 
            // if we changed from an existing value to not having a value
            if ( old_resource_values["nodes"] != "" ) {
              $("#" + id + "-nodes-warning").show();
            }
            {%- endif %}

            {%- if "gpus" in spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}) %}
            var min = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("gpus", {}).get("minmax", [0, 1])[0] }};
            var max = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("gpus", {}).get("minmax", [0, 1])[1] }};
            if (user_options[id] && user_options[id]["gpus"]) {
              var value = user_options[id]["gpus"];
            } else
              var value = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("gpus", {}).get("default", 0) }};

            $("#" + id + "-gpus-text").text("GPUs [" + min + "," + max + "]");
            gpus_input.attr({"min": min, "max": max, "value": value});
            gpus_input.val(value);
            gpus_input.attr("required", true);
            // Set message for invalid feedback
            gpus_input.siblings(".invalid-feedback").text(`Please choose a number between ${min} and ${max}.`);
            $("#" + id + "-gpus-input-div").show();
            var should_show = true;
            updateInput(id, old_resource_values["gpus"], value, min, max, gpus_input);
            {%- else %}
            $("#" + id + "-gpus-input-div").hide();
            // Show warning even if the div is hidden 
            // if we changed from an existing value to not having a value
            if ( old_resource_values["gpus"] != "" ) {
              $("#" + id + "-gpus-warning").show();
            }
            {%- endif %}

            {%- if "runtime" in spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}) %}
            var min = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("runtime", {}).get("minmax", [0, 1])[0] }};
            var max = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("runtime", {}).get("minmax", [0, 1])[1] }};
            if (user_options[id] && user_options[id]["runtime"]) {
              var value = user_options[id]["runtime"] / 60;
            } else
              var value = {{ spawner_options_form.get('resources', {}).get(option, {}).get(system, {}).get(partition, {}).get("runtime", {}).get("default", 0) }};
            $("#" + id + "-runtime-text").text("Runtime (min) [" + min + "," + max + "]");
            runtime_input.attr({"min": min, "max": max, "value": value});
            runtime_input.val(value);
            runtime_input.attr("required", true);
            // Set message for invalid feedback
            runtime_input.siblings(".invalid-feedback").text(`Please choose a number between ${min} and ${max}.`);
            updateInput(id, old_resource_values["runtime"], value, min, max, runtime_input)
            $("#" + id + "-runtime-input-div").show();
            var should_show = true;
            {%- else %}
            $("#" + id + "-runtime-input-div").hide();
            // Show warning even if the div is hidden 
            // if we changed from an existing value to not having a value
            if ( old_resource_values["runtime"] != "" ) {
              $("#" + id + "-runtime-warning").show();
            };
            {%- endif %}

            {%- if reservations_allowed | length > 0 and reservations_allowed != ["None"] %}
              {#- cannot use unique for list containing dictionary so use variable to keep track #}
              {%- set reservation_list = [] %}
              {%- for reservation in spawner_options_form.get('dropdown_lists', {}).get('reservations', {}).get(system, {}).get(account, {}).get(project, {}).get(partition, []) %}                
                {%- if reservation in reservations_allowed and reservation not in reservation_list %}
                  {{ reservation_list.append(reservation) | default("", True) }}
                  {%- if reservation == "None" %}
                  reservation = "None";
                  $("#" + id + "-reservation-select").append('<option value="{{reservation}}">{{reservation}}</option>');
                  reservation_values.push("{{reservation}}");
                  {%- else %}
                    {# Check Reservation Info Dict for more information #}
                    {%- for reservation_line in spawner_options_form.get('reservations', {}).get(system, []) %}
                      {%- if reservation == reservation_line %}
                        reservation = "{{reservation.get('ReservationName') | safe}}";
                        {%- if reservation_line.get('State', "INACTIVE") == "INACTIVE" %}
                          $("#" + id + "-reservation-select").append(`<option value="${reservation}" disabled style="color: #6c757d;">${reservation} [INACTIVE]</option>`);
                          reservation_values.push(reservation);
                        {%- else %}
                          $("#" + id + "-reservation-select").append(`<option value="${reservation}">${reservation}</option>`);
                          reservation_values.push(reservation);
                        {%- endif %}
                      {%- endif %}
                    {%- endfor %}
                  {%- endif %}
                {%- endif %} {# reservation in reservations_allowed #}
              {%- endfor %}    
                    
              if (user_options[id] && user_options[id]["reservation"]) {
                $("#" + id + "-reservation-select").val(user_options[id]["reservation"]);
              }
              reservation_select.attr("required", true);
              $("#" + id + "-reservation-select-div").show();
              reservation_tab.removeClass("disabled");

              if ( reservation != "None" ) {
                  updateSelect(reservation_select, id, reservation_value, old_reservation_value, reservation_values, tab_id="reservation");
              } else {
                reservation_select.val(reservation);
              }
            {%- else %}
              $("#" + id + "-reservation-select-div").hide();
            {%- endif %} {# reservations_allowed #}

          } {# end of comparison of options (option == option) #}
          {%- endfor %} {# partitions #}
        {%- endfor %} {# project #}
      {%- endfor %} {# account #}
    {%- endfor %} {# system #}
  {%- endfor %} {# option #}

  // Only check at end if we should enable the tab so that the 
  // updateInput function gets the correct value for disabled
  if (should_show) {
    resource_tab.removeClass("disabled");
  }
  // Dispatch update event at the very end so that the warning
  // symbol disappears if the tab is disabled
  var resources_tab_warning = $("#" + id + "-resources-tab-warning");
  resources_tab_warning[0].dispatchEvent(new Event("change"));
  var reservation_tab_warning = $("#" + id + "-reservation-tab-warning");
  reservation_tab_warning[0].dispatchEvent(new Event("change"));
}
</script>

<script>
/* Connect to SSE to get notified of new servers */
evtSources = {}
{#- Manually set cancel_progress_activation until added to template -#}
{%- set cancel_progress_activation = 30 %}

function updateSpawners() {
  {%- for s in named_spawners %}
    var latest_events = spawn_events["{{s.name}}"]["latest"];
    if (latest_events.length > 0) {
      var last_event = latest_events.slice(-1)[0];
      var current_progress = last_event.progress;
    }
    else var current_progress = 0;

    var name = "{{s.name}}";
    var progress_bar = $("#" + name + "-progress-bar");
    var progress_info = $("#" + name + "-progress-info-text");
    var progress_log = $("#" + name + "-progress-log");

    var tr = progress_bar.parents("tr");
    var open_btn = tr.find(".open");
    var stop_btn = tr.find(".stop, .cancel");
    
    // Append log messages
    for (const event in latest_events) {
      var html_message = latest_events[event]["html_message"];
      no_duplicate_log(html_message, progress_log);
      // tab_log.append($("<div>").html(html_message));
    }

    // Add options to log select
    var log_select = $("#" + name + "-log-select");
    for (const log in spawn_events["{{s.name}}"]) {
      if (log == "latest") log_select.prepend(`<option value="${log}">${log}</option>`);
      else log_select.append(`<option value="${log}">${log}</option>`);
    }
    log_select.val("latest");

    // Make progress td visible and set the progress bar to the correct width
    // if the spawner if currenty spawning
    {%- if not s.ready and s.active %}
    progress_bar.css("width", "100%");
    progress_bar.attr("aria-valuenow", current_progress);
    progress_bar.append( $("b").html(current_progress + "%") );
    progress_info.html("spawning...");
    open_btn.addClass("disabled");
    if (current_progress < {{cancel_progress_activation}}) {
      stop_btn.addClass("disabled");
    }
    // Disable the delete button during the spawn process
    var collapse = $(`.collapse-tr[data-server-name=${name}]`);
    collapse.find(".delete").addClass("disabled");

    // Reattach event listener
    var progress_url = `${jhdata.base_url}api/users/${jhdata.user}/servers/${name}/progress`;
    evtSources[name] = new EventSource(progress_url);
    // save variables in evtSource Object and use outside of loop to avoid overwriting
    // what is a better solution for this?
    evtSources[name]["name"] = name;
    evtSources[name]["progress_bar"] = progress_bar;
    evtSources[name]["progress_info"] = progress_info;
    evtSources[name]["progress_log"] = progress_log;

    {%- elif s.active %}
    progress_bar.css("width", "100%");
    progress_bar.attr("aria-valuenow", current_progress);
    progress_bar.addClass("bg-success");
    progress_info.html("running");
    {%- endif %}
  {%- endfor %}

  for (const name in evtSources) {
    evtSources[name].onmessage = function (e) {
      onEvtMessage(e, evtSources[name], evtSources[name]["progress_bar"], 
        evtSources[name]["progress_info"], evtSources[name]["progress_log"]);
    }
  }
}

// Handle EventSource message
function onEvtMessage(event, evtSource, progress_bar, progress_info, progress_log) {
  var tr = progress_bar.parents("tr");
  var server_name = tr.data("server-name");
  var collapse = tr.siblings(`.collapse-tr[data-server-name=${server_name}]`);
  var open_btn = tr.find(".open");
  var cancel_btn = tr.find(".cancel");
  var stop_btn = tr.find(".stop");
  var delete_btn = collapse.find(".delete").addClass("disabled");
  var log_select = $("#" + server_name + "-log-select");

  var evt = JSON.parse(event.data);
  // console.log(evt);
  spawn_events[server_name]["latest"].push(evt);

  if (evt.progress !== undefined && evt.progress != 0) {
    // update progress
    // progress_bar.css("width", evt.progress + "%");
    progress_bar.css("width", "100%");
    progress_bar.html("<b>" + evt.progress + "%</b>");
    progress_bar.attr("aria-valuenow", evt.progress);
    progress_info.html("spawning...");
    delete_btn.addClass("disabled")

    if (evt.progress >= {{cancel_progress_activation}}) {
      cancel_btn.removeClass("disabled");
    }
  }

  if (evt.html_message !== undefined) {
    var html_message = evt.html_message
    html_message = html_message.replace(/&nbsp;/g, ' ');
  } else if (evt.message !== undefined) {
    var html_message = evt.message;
    html_message = html_message.replace(/&nbsp;/g, ' ');
  }
  if (html_message) {
    // only append if latest log is selected
    if (log_select.val() == "latest")
      no_duplicate_log(html_message, progress_log);
  }

  if (evt.ready) {
    evtSource.close();
    delete evtSources[evtSource.name];
    progress_bar.html('');
    progress_bar.addClass("bg-success");
    progress_info.html("running");
    cancel_btn.addClass("d-none disabled");
    stop_btn.removeClass("d-none disabled");
    open_btn.removeClass("disabled");
    delete_btn.removeClass("disabled");
  }

  if (evt.failed) {
    evtSource.close();
    delete evtSources[evtSource.name];
    progress_bar.html('');
    progress_bar.attr("aria-valuenow", 100);
    progress_bar.addClass("bg-danger");
    progress_info.html("last spawn failed");
    // Change buttons to start or N/A
    var na = tr.find(".na-status").text();
    if (na == "1") {
        tr.find(".na").removeClass("d-none")
        tr.find(".start").addClass("d-none");
    } else {
      tr.find(".na").addClass("d-none")
      tr.find(".start").removeClass("d-none");
    }
    open_btn.addClass("d-none disabled");
    cancel_btn.addClass("d-none disabled");
    delete_btn.removeClass("disabled");
  }
}

function no_duplicate_log(html_message, progress_log) {
  // Check current messages
    var current_messages = [];
    progress_log.children().each(function() {
      var current_html = $(this).children().first();
      current_messages.push(current_html.text());
    })
    try {
      var html_text = $(html_message).text();
    } catch {
      var html_text = html_message;
    }

    // and only append if message has not been logged yet
    if ( !current_messages.includes(html_text) ) {
      progress_log.append($('<div class="log-div">').html(html_message));
    } 
}
</script>

<script src='{{static_url("js/home-servers.js", include_version=False) }}' type="text/javascript" charset="utf-8"></script>
<script src='{{static_url("js/home-ui.js", include_version=False) }}' type="text/javascript" charset="utf-8"></script>
{%- endblock %}